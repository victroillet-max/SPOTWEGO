<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotwego - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Spotwego Brand Colors
                        'spot-burgundy': '#6B4444',      // Primary - Dark burgundy from header
                        'spot-maroon': '#7A4848',        // Slightly lighter burgundy
                        'spot-rose': '#C4A4A4',          // Muted rose/pink accent
                        'spot-cream': '#FAF7F5',         // Light cream background
                        'spot-beige': '#F5F0ED',         // Beige tones
                        'spot-dark': '#3D2929',          // Dark text
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .sidebar-link { transition: all 0.2s; }
        .sidebar-link:hover { background: rgba(255,255,255,0.1); }
        .sidebar-link.active { background: rgba(255,255,255,0.15); border-right: 3px solid #C4A4A4; }
        .card { transition: box-shadow 0.2s; }
        .card:hover { box-shadow: 0 4px 20px rgba(107,68,68,0.12); }
        .slider { -webkit-appearance: none; height: 6px; background: #e5e7eb; border-radius: 3px; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #6B4444; border-radius: 50%; cursor: pointer; }
        #map { height: 450px; border-radius: 12px; }
        .fresh { color: #22c55e; } .stale { color: #f59e0b; } .old { color: #ef4444; } .never { color: #9ca3af; }
        .bg-fresh { background: #22c55e; } .bg-stale { background: #f59e0b; } .bg-old { background: #ef4444; } .bg-never { background: #9ca3af; }
        .toggle { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: #cbd5e1; border-radius: 24px; transition: 0.3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle input:checked + .toggle-slider { background: #6B4444; }
        .toggle input:checked + .toggle-slider:before { transform: translateX(20px); }
        .btn-primary { background: #6B4444; color: white; }
        .btn-primary:hover { background: #5a3939; }
        .btn-secondary { background: #7A4848; color: white; }
        .btn-secondary:hover { background: #6B4444; }
        /* Fix: Ensure hidden elements don't block clicks */
        .hidden { display: none !important; pointer-events: none !important; }
        /* Fix: Ensure toast doesn't block clicks when invisible */
        #toast.opacity-0, #toast.translate-y-20 { pointer-events: none !important; }
        /* Fix: Ensure modals don't block clicks when hidden */
        [id$="-modal"].hidden { pointer-events: none !important; visibility: hidden !important; }
    </style>
</head>
<body class="bg-gray-50">
<div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-spot-burgundy text-white flex flex-col">
        <div class="p-5 border-b border-spot-maroon">
            <div class="font-semibold text-xl tracking-wide">Spotwego</div>
            <div class="text-xs text-spot-rose">Admin Dashboard</div>
        </div>
        
        <nav class="flex-1 py-4 overflow-auto">
            <div class="px-4 py-2 text-xs text-spot-rose uppercase tracking-wider">Overview</div>
            <a href="#" onclick="showSection('dashboard')" class="sidebar-link active flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="dashboard">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path></svg>
                Dashboard
            </a>
            <a href="#" onclick="showSection('map')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="map">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                Region Map
            </a>
            
            <div class="px-4 py-2 mt-4 text-xs text-spot-rose uppercase tracking-wider">Ranking</div>
            <a href="#" onclick="showSection('model')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="model">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                Model Weights
            </a>
            <a href="#" onclick="showSection('restaurants')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="restaurants">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                Restaurants
            </a>
            <a href="#" onclick="showSection('rankings')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="rankings">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
                Rankings
            </a>
            
            <div class="px-4 py-2 mt-4 text-xs text-spot-rose uppercase tracking-wider">Data Sources</div>
            <a href="#" onclick="showSection('api-keys')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="api-keys">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                API Keys
            </a>
            <a href="#" onclick="showSection('cost-analytics')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="cost-analytics">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Cost Analytics
            </a>
            <a href="#" onclick="showSection('scraping')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="scraping">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                Data Collection
            </a>
            
            <div class="px-4 py-2 mt-4 text-xs text-spot-rose uppercase tracking-wider">Integration</div>
            <a href="#" onclick="showSection('website')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="website">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                Website Push
            </a>
            <a href="#" onclick="showSection('emails')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="emails">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                Email Notifications
            </a>
            <a href="#" onclick="showSection('automation')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="automation">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Daily Automation
            </a>
            <a href="#" onclick="showSection('user-reviews')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="user-reviews">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"></path></svg>
                User Reviews API
            </a>
            
            <div class="px-4 py-2 mt-4 text-xs text-spot-rose uppercase tracking-wider">System</div>
            <a href="#" onclick="showSection('health-check')" class="sidebar-link flex items-center px-6 py-3 text-sm text-white/90 hover:text-white" data-section="health-check">
                <svg class="w-5 h-5 mr-3 text-spot-rose" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Health Check
            </a>
        </nav>
        
        <div class="p-4 border-t border-spot-maroon">
            <div class="text-xs text-spot-rose">Version 3.45</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto">
        <header class="bg-white border-b px-8 py-4 flex justify-between items-center">
            <h1 class="text-xl font-semibold text-gray-800" id="pageTitle">Dashboard</h1>
            <div class="flex items-center space-x-4">
                <select id="globalCity" class="border rounded-lg px-3 py-2 text-sm" onchange="onRegionChange()">
                    <option value="">All Cities</option>
                </select>
                <button onclick="refreshData()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
            </div>
        </header>

        <div class="p-8">
            <!-- Dashboard -->
            <section id="section-dashboard" class="section">
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
                    <div class="bg-white rounded-xl border p-5 card">
                        <div class="text-sm text-gray-500">Restaurants</div>
                        <div class="text-2xl font-bold text-spot-dark" id="stat-restaurants">0</div>
                    </div>
                    <div class="bg-white rounded-xl border p-5 card">
                        <div class="text-sm text-gray-500">Cities</div>
                        <div class="text-2xl font-bold text-spot-maroon" id="stat-cities">0</div>
                    </div>
                    <div class="bg-white rounded-xl border p-5 card">
                        <div class="text-sm text-gray-500">Reviews</div>
                        <div class="text-2xl font-bold text-spot-dark" id="stat-reviews">0</div>
                    </div>
                    <div class="bg-white rounded-xl border p-5 card">
                        <div class="text-sm text-gray-500">User Reviews</div>
                        <div class="text-2xl font-bold text-purple-600" id="stat-user-reviews">0</div>
                    </div>
                    <div class="bg-white rounded-xl border p-5 card">
                        <div class="text-sm text-gray-500">Published</div>
                        <div class="text-2xl font-bold text-spot-maroon" id="stat-published">0</div>
                    </div>
                    <div class="bg-white rounded-xl border p-5 card">
                        <div class="text-sm text-gray-500">Pushed</div>
                        <div class="text-2xl font-bold text-spot-burgundy" id="stat-pushed">0</div>
                    </div>
                    <div class="bg-white rounded-xl border p-5 card">
                        <div class="text-sm text-gray-500">API Cost (Month)</div>
                        <div class="text-2xl font-bold text-amber-600" id="stat-api-cost">$0.00</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl border p-6">
                        <h3 class="font-semibold mb-4">Recent Jobs</h3>
                        <div id="recent-jobs" class="space-y-2 text-sm"></div>
                    </div>
                    <div class="bg-white rounded-xl border p-6">
                        <h3 class="font-semibold mb-4">Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="showSection('scraping')" class="text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg">
                                <div class="font-medium text-sm">Collect Data</div>
                            </button>
                            <button onclick="showSection('model')" class="text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg">
                                <div class="font-medium text-sm">Model Weights</div>
                            </button>
                            <button onclick="showSection('rankings')" class="text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg">
                                <div class="font-medium text-sm">Manage Rankings</div>
                            </button>
                            <button onclick="runDailyTasks()" class="text-left p-3 bg-blue-50 hover:bg-spot-burgundy/20 rounded-lg">
                                <div class="font-medium text-sm text-spot-burgundy">Run Daily Tasks</div>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Region Map -->
            <section id="section-map" class="section hidden">
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-2">Data Freshness Map</h3>
                    <div class="flex space-x-4 text-sm mb-4">
                        <span class="flex items-center"><span class="w-3 h-3 rounded-full bg-fresh mr-2"></span>Fresh (&lt;30d)</span>
                        <span class="flex items-center"><span class="w-3 h-3 rounded-full bg-stale mr-2"></span>Stale (30-60d)</span>
                        <span class="flex items-center"><span class="w-3 h-3 rounded-full bg-old mr-2"></span>Old (&gt;60d)</span>
                        <span class="flex items-center"><span class="w-3 h-3 rounded-full bg-never mr-2"></span>Never</span>
                    </div>
                    <div id="map"></div>
                </div>
                
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-4">Cities</h3>
                    <div id="cities-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>
                
                <div class="bg-white rounded-xl border p-6">
                    <h3 class="font-semibold mb-4">Add New Region</h3>
                    <form onsubmit="addRegion(event)" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="new-city-name" class="border rounded-lg px-4 py-2" placeholder="City name (e.g., Montreux)" required>
                        <input type="number" step="0.0001" id="new-city-lat" class="border rounded-lg px-4 py-2" placeholder="Latitude">
                        <input type="number" step="0.0001" id="new-city-lng" class="border rounded-lg px-4 py-2" placeholder="Longitude">
                        <button type="submit" class="bg-spot-burgundy text-white rounded-lg px-4 py-2">Add Region</button>
                    </form>
                </div>
            </section>

            <!-- API Keys -->
            <section id="section-api-keys" class="section hidden">
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold">API Keys</h3>
                        <button onclick="checkAllApiHealth()" class="text-sm border px-4 py-2 rounded-lg hover:bg-gray-50">
                            Check All Health
                        </button>
                    </div>
                    <div id="api-keys-list" class="space-y-3"></div>
                </div>
                <div class="bg-white rounded-xl border p-6">
                    <h3 class="font-semibold mb-4">Add / Update API Key</h3>
                    <form onsubmit="saveApiKey(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <select id="key-provider" class="border rounded-lg px-4 py-2">
                            <option value="google">Google Places</option>
                            <option value="yelp">Yelp Fusion</option>
                            <option value="tripadvisor">TripAdvisor</option>
                        </select>
                        <input type="password" id="key-value" class="border rounded-lg px-4 py-2" placeholder="API Key">
                        <button type="submit" class="bg-spot-burgundy text-white rounded-lg px-4 py-2">Save Key</button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2">Keys are stored securely. Only a masked preview is shown.</p>
                </div>
            </section>

            <!-- Cost Analytics -->
            <section id="section-cost-analytics" class="section hidden">
                <!-- Header with refresh -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-lg font-semibold">API Cost Analytics</h2>
                        <div id="cost-last-updated" class="text-xs text-gray-400">Last updated: -</div>
                    </div>
                    <button onclick="loadCostAnalytics()" class="text-sm text-spot-burgundy hover:underline flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        Refresh
                    </button>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl border p-4">
                        <div class="text-sm text-gray-500">Today's Cost</div>
                        <div class="text-2xl font-bold text-spot-burgundy" id="cost-today">$0.00</div>
                    </div>
                    <div class="bg-white rounded-xl border p-4">
                        <div class="text-sm text-gray-500">This Month</div>
                        <div class="text-2xl font-bold text-spot-maroon" id="cost-month">$0.00</div>
                    </div>
                    <div class="bg-white rounded-xl border p-4">
                        <div class="text-sm text-gray-500">Total API Calls</div>
                        <div class="text-2xl font-bold text-gray-700" id="cost-calls">0</div>
                    </div>
                    <div class="bg-white rounded-xl border p-4">
                        <div class="text-sm text-gray-500">All Time Cost</div>
                        <div class="text-2xl font-bold text-gray-700" id="cost-total">$0.00</div>
                    </div>
                </div>

                <!-- Cost Breakdown -->
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-4">Cost by API Operation</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="text-left text-gray-500 border-b">
                                <tr>
                                    <th class="pb-2">Operation</th>
                                    <th class="pb-2">Provider</th>
                                    <th class="pb-2">Calls</th>
                                    <th class="pb-2">Cost per Call</th>
                                    <th class="pb-2">Total Cost</th>
                                </tr>
                            </thead>
                            <tbody id="cost-breakdown-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Google Places API Pricing Reference -->
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-4">Google Places API Pricing Reference</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2">Nearby Search (per request)</h4>
                            <table class="w-full text-sm">
                                <tr class="border-b">
                                    <td class="py-2">Basic (name, location, types)</td>
                                    <td class="py-2 text-green-600 font-medium">FREE</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2">Essential (+ address, rating, reviews)</td>
                                    <td class="py-2 text-amber-600 font-medium">$0.032</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2">Pro (+ opening hours, photos)</td>
                                    <td class="py-2 text-red-600 font-medium">$0.035</td>
                                </tr>
                            </table>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2">Place Details (per request)</h4>
                            <table class="w-full text-sm">
                                <tr class="border-b">
                                    <td class="py-2">Basic fields</td>
                                    <td class="py-2 text-green-600 font-medium">FREE</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2">Contact fields</td>
                                    <td class="py-2 text-amber-600 font-medium">$0.003</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2">Atmosphere fields</td>
                                    <td class="py-2 text-red-600 font-medium">$0.005</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-700">
                            <strong>Spotwego uses cost-optimized queries:</strong><br>
                            • Quick Preview uses only Basic fields (FREE)<br>
                            • Fetch Details uses Essential fields (~$0.017 per place)
                        </p>
                    </div>
                </div>

                <!-- Usage History -->
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold">Recent API Usage</h3>
                        <div class="flex gap-2">
                            <select id="cost-period" class="border rounded-lg px-3 py-2 text-sm" onchange="loadCostAnalytics()">
                                <option value="today">Today</option>
                                <option value="week" selected>Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                                <option value="all">All Time</option>
                            </select>
                            <button onclick="clearCostHistory()" class="text-red-500 text-sm hover:underline">Clear History</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-80 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="text-left text-gray-500 border-b sticky top-0 bg-white">
                                <tr>
                                    <th class="pb-2">Time</th>
                                    <th class="pb-2">Operation</th>
                                    <th class="pb-2">Provider</th>
                                    <th class="pb-2">Calls</th>
                                    <th class="pb-2">Cost</th>
                                </tr>
                            </thead>
                            <tbody id="cost-history-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Cost Estimator -->
                <div class="bg-gradient-to-r from-spot-cream to-white rounded-xl border-2 border-spot-rose p-6">
                    <h3 class="font-semibold text-spot-burgundy mb-4">Cost Estimator</h3>
                    <p class="text-sm text-gray-600 mb-4">Estimate costs before running operations:</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Operation</label>
                            <select id="estimate-operation" class="w-full border rounded-lg px-3 py-2" onchange="calculateEstimate()">
                                <option value="preview">Quick Preview</option>
                                <option value="details">Fetch Details</option>
                                <option value="full">Full Search + Import</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Number of Restaurants</label>
                            <input type="number" id="estimate-count" class="w-full border rounded-lg px-3 py-2" value="100" onchange="calculateEstimate()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Estimated Cost</label>
                            <div class="w-full border rounded-lg px-3 py-2 bg-gray-50 font-bold text-xl text-spot-burgundy" id="estimate-result">$0.00</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Data Collection -->
            <section id="section-scraping" class="section hidden">
                <!-- Search Mode Toggle -->
                <div class="flex gap-2 mb-4">
                    <button onclick="setSearchMode('cost')" id="mode-cost" class="px-4 py-2 rounded-lg font-medium bg-spot-burgundy text-white">
                        Cost Optimized
                    </button>
                    <button onclick="setSearchMode('quick')" id="mode-quick" class="px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700">
                        Quick Search
                    </button>
                </div>

                <!-- Cost Optimization Info (for cost mode) -->
                <div id="cost-mode-info" class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <h4 class="font-semibold text-blue-800 mb-2">Cost-Optimized Search</h4>
                    <p class="text-sm text-blue-700">
                        <strong>Quick Preview (FREE)</strong>: Get restaurant names only - no API cost<br>
                        <strong>Fetch Details (Paid)</strong>: Get ratings, reviews, address only for selected restaurants (~$0.03 per 20)
                    </p>
                </div>

                <!-- Quick Search Info (for quick mode) -->
                <div id="quick-mode-info" class="hidden bg-purple-50 border border-purple-200 rounded-xl p-4 mb-6">
                    <h4 class="font-semibold text-purple-800 mb-2">Quick Search (Single Request)</h4>
                    <p class="text-sm text-purple-700">
                        One API call fetches all details at once. Filter by minimum rating to import only quality restaurants.<br>
                        <strong>Cost</strong>: ~$0.03 per 20 restaurants in results
                    </p>
                </div>

                <!-- Step 1: Search (Cost Mode) -->
                <div id="cost-search-panel" class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-4">Step 1: Quick Preview</h3>
                    <form onsubmit="quickPreview(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">City</label>
                                <input type="text" id="search-city" class="w-full border rounded-lg px-4 py-2" placeholder="e.g., Paris, London" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Country</label>
                                <select id="search-country" class="w-full border rounded-lg px-4 py-2">
                                    <option value="Switzerland">Switzerland</option>
                                    <option value="France">France</option>
                                    <option value="Germany">Germany</option>
                                    <option value="Italy">Italy</option>
                                    <option value="UK">United Kingdom</option>
                                    <option value="Spain">Spain</option>
                                    <option value="USA">United States</option>
                                    <option value="Netherlands">Netherlands</option>
                                    <option value="Belgium">Belgium</option>
                                    <option value="Austria">Austria</option>
                                    <option value="Portugal">Portugal</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Radius</label>
                                <select id="search-radius" class="w-full border rounded-lg px-4 py-2">
                                    <option value="1">1 km</option>
                                    <option value="2">2 km</option>
                                    <option value="5" selected>5 km</option>
                                    <option value="10">10 km</option>
                                    <option value="20">20 km</option>
                                    <option value="50">50 km</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Max Preview</label>
                                <select id="search-max-results" class="w-full border rounded-lg px-4 py-2">
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="200" selected>200</option>
                                    <option value="500">500</option>
                                    <option value="1000">1000</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="submit" id="preview-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                                Quick Preview (FREE)
                            </button>
                            <span class="text-xs text-gray-500">Returns names only - no API cost</span>
                        </div>
                    </form>
                </div>

                <!-- Quick Search Panel -->
                <div id="quick-search-panel" class="hidden bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-4">Quick Search</h3>
                    <form onsubmit="quickSearchDirect(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">City</label>
                                <input type="text" id="quick-city" class="w-full border rounded-lg px-4 py-2" placeholder="e.g., Geneva" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Country</label>
                                <select id="quick-country" class="w-full border rounded-lg px-4 py-2">
                                    <option value="Switzerland">Switzerland</option>
                                    <option value="France">France</option>
                                    <option value="Germany">Germany</option>
                                    <option value="Italy">Italy</option>
                                    <option value="UK">United Kingdom</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Min Rating</label>
                                <select id="quick-min-rating" class="w-full border rounded-lg px-4 py-2">
                                    <option value="0">Any rating</option>
                                    <option value="3.5">3.5+ stars</option>
                                    <option value="4.0" selected>4.0+ stars</option>
                                    <option value="4.3">4.3+ stars</option>
                                    <option value="4.5">4.5+ stars</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Max Results</label>
                                <select id="quick-max-results" class="w-full border rounded-lg px-4 py-2">
                                    <option value="10">10</option>
                                    <option value="20" selected>20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">&nbsp;</label>
                                <button type="submit" id="quick-search-btn" class="w-full bg-purple-600 text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                                    Search & Fetch
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">Fetches all details in one request. Results can be directly imported.</p>
                    </form>
                </div>
                
                <!-- Step 2: Preview Results -->
                <div id="search-results-panel" class="hidden bg-white rounded-xl border p-6 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-semibold">Step 2: Select Restaurants</h3>
                            <p class="text-sm text-gray-500" id="search-results-summary">Found 0 restaurants</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="selectAllResults(true)" class="text-sm text-spot-burgundy hover:underline">Select All</button>
                            <button onclick="selectAllResults(false)" class="text-sm text-gray-500 hover:underline">Deselect All</button>
                        </div>
                    </div>
                    
                    <div id="duplicate-warning" class="hidden mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                        <p class="text-amber-800 text-sm">
                            <strong> Duplicates detected:</strong> <span id="duplicate-count">0</span> restaurants already exist in your database.
                            They are marked with a yellow background below.
                        </p>
                        <!-- Filter controls for preview -->
                        <div id="preview-filters" class="hidden mt-2 flex flex-wrap gap-2 items-center text-sm">
                            <span class="text-gray-500">Filter:</span>
                            <input type="text" id="filter-name" placeholder="Name contains..." class="border rounded px-2 py-1 text-sm w-40" oninput="filterPreviewResults()">
                            <select id="filter-type" class="border rounded px-2 py-1 text-sm" onchange="filterPreviewResults()">
                                <option value="">All types</option>
                                <option value="restaurant">Restaurant</option>
                                <option value="cafe">Café</option>
                                <option value="bar">Bar</option>
                                <option value="bakery">Bakery</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="text-left text-gray-500 border-b sticky top-0 bg-white">
                                <tr>
                                    <th class="pb-2 w-8"><input type="checkbox" id="select-all-search" onchange="selectAllResults(this.checked)" checked></th>
                                    <th class="pb-2">Name</th>
                                    <th class="pb-2">Type</th>
                                    <th class="pb-2" id="col-rating">Rating</th>
                                    <th class="pb-2" id="col-reviews">Reviews</th>
                                    <th class="pb-2" id="col-price">Price</th>
                                    <th class="pb-2 text-center" id="col-email">Email</th>
                                    <th class="pb-2 text-center" id="col-phone">Phone</th>
                                    <th class="pb-2">Status</th>
                                </tr>
                            </thead>
                            <tbody id="search-results-table"></tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex flex-wrap items-center gap-4">
                        <!-- Step 2: Fetch Details (only shown after preview) -->
                        <button onclick="fetchDetailsForSelected()" id="fetch-details-btn" class="hidden bg-spot-burgundy text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                            Fetch Details (<span id="fetch-count">0</span>) ~$<span id="fetch-cost">0.00</span>
                        </button>
                        
                        <!-- Step 3: Import (only shown after details fetched) -->
                        <button onclick="importSelected()" id="import-btn" class="hidden bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                            Import Selected (<span id="selected-count">0</span>)
                        </button>
                        
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="skip-duplicates" checked class="mr-2">
                            Skip duplicates
                        </label>
                        <button onclick="clearSearchResults()" class="text-gray-500 text-sm hover:underline">Clear Results</button>
                    </div>
                    
                    <!-- Progress indicator -->
                    <div id="fetch-progress" class="hidden mt-4 bg-gray-100 rounded-lg p-3">
                        <div class="flex items-center gap-2">
                            <div class="animate-spin w-5 h-5 border-2 border-spot-burgundy border-t-transparent rounded-full"></div>
                            <span id="fetch-progress-text">Fetching details...</span>
                        </div>
                        <div class="mt-2 bg-gray-200 rounded-full h-2">
                            <div id="fetch-progress-bar" class="bg-spot-burgundy h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Duplicate Checker -->
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="font-semibold"> Duplicate Checker</h3>
                            <p class="text-sm text-gray-500">Find and manage duplicate restaurants in your database</p>
                        </div>
                        <button onclick="checkDuplicates()" class="border border-spot-burgundy text-spot-burgundy px-4 py-2 rounded-lg text-sm hover:bg-spot-cream transition">
                            Check for Duplicates
                        </button>
                    </div>
                    <div id="duplicates-list" class="hidden"></div>
                </div>
                
                <!-- Demo Data Section -->
                <div class="bg-gradient-to-r from-spot-cream to-white rounded-xl border-2 border-spot-rose p-6 mb-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="font-semibold text-spot-burgundy mb-2">Demo Data - Test Before Going Live</h3>
                            <p class="text-sm text-gray-600 mb-4">Load realistic demo data to test the complete workflow: rankings, publishing, emails, and website push.</p>
                            <div class="text-sm text-gray-500 space-y-1">
                                <div>- <strong>5 Swiss cities</strong>: Geneva, Zurich, Lausanne, Basel, Bern</div>
                                <div>- <strong>31 restaurants</strong> with real names and addresses</div>
                                <div>- <strong>Reviews from 3 sources</strong>: Google, Yelp, TripAdvisor</div>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2 ml-6">
                            <button onclick="loadDemoData()" id="demo-load-btn" class="bg-spot-burgundy text-white px-6 py-3 rounded-lg font-medium hover:opacity-90 transition">
                                Load Demo Data
                            </button>
                            <button onclick="computeAllRankings()" class="border border-green-500 text-green-600 px-6 py-2 rounded-lg text-sm hover:bg-green-50 transition">
                                Compute All Rankings
                            </button>
                            <button onclick="runHealthCheck()" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm hover:bg-blue-700 transition font-medium">
                                Full Database Health Check
                            </button>
                            <button onclick="clearAllData()" class="border border-red-300 text-red-600 px-6 py-2 rounded-lg text-sm hover:bg-red-50 transition">
                                Clear All Data
                            </button>
                        </div>
                    </div>
                    <div id="demo-status" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm"></div>
                    <div id="demo-diagnose" class="hidden mt-4 p-3 bg-gray-900 text-gray-100 rounded-lg text-xs font-mono whitespace-pre-wrap overflow-x-auto max-h-96 overflow-y-auto"></div>
                </div>
                
                <!-- Import History -->
                <div class="bg-white rounded-xl border p-6">
                    <h3 class="font-semibold mb-4">Import History</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="text-left text-gray-500 border-b">
                                <tr><th class="pb-2">ID</th><th class="pb-2">Location</th><th class="pb-2">Status</th><th class="pb-2">Imported</th><th class="pb-2">Date</th></tr>
                            </thead>
                            <tbody id="job-history"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Model Weights -->
            <section id="section-model" class="section hidden">
                <div class="bg-white rounded-xl border p-6">
                    <h3 class="font-semibold mb-2">Ranking Model Configuration</h3>
                    <p class="text-sm text-gray-500 mb-6">Adjust weights to fine-tune the ranking algorithm</p>
                    
                    <form onsubmit="saveWeights(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-medium mb-4">Provider Weights</h4>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between text-sm mb-1"><span>Google</span><span id="w-google-val">0.25</span></div>
                                        <input type="range" id="w-google" min="0" max="1" step="0.05" value="0.25" class="slider w-full" oninput="updateWeight('google')">
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1"><span>Yelp</span><span id="w-yelp-val">0.20</span></div>
                                        <input type="range" id="w-yelp" min="0" max="1" step="0.05" value="0.20" class="slider w-full" oninput="updateWeight('yelp')">
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1"><span>TripAdvisor</span><span id="w-tripadvisor-val">0.25</span></div>
                                        <input type="range" id="w-tripadvisor" min="0" max="1" step="0.05" value="0.25" class="slider w-full" oninput="updateWeight('tripadvisor')">
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1"><span>User Reviews</span><span id="w-user_reviews-val">0.15</span></div>
                                        <input type="range" id="w-user_reviews" min="0" max="1" step="0.05" value="0.15" class="slider w-full" oninput="updateWeight('user_reviews')">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-medium mb-4">Quality Factors</h4>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between text-sm mb-1"><span>Sentiment (Overall)</span><span id="w-sentiment-val">0.10</span></div>
                                        <input type="range" id="w-sentiment" min="0" max="0.5" step="0.05" value="0.10" class="slider w-full" oninput="updateWeight('sentiment')">
                                    </div>
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="font-medium text-blue-800">Text vs Stars Balance</span>
                                            <span id="w-text_sentiment-val" class="text-blue-800">0.50</span>
                                        </div>
                                        <input type="range" id="w-text_sentiment" min="0" max="1" step="0.1" value="0.50" class="slider w-full" oninput="updateWeight('text_sentiment')">
                                        <div class="flex justify-between text-xs text-blue-600 mt-1">
                                            <span>Stars Only</span>
                                            <span>Equal</span>
                                            <span>Text Only</span>
                                        </div>
                                        <p class="text-xs text-blue-600 mt-2">
                                            How much weight to give written review text vs star ratings when calculating sentiment.
                                        </p>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1"><span>Data Quality</span><span id="w-data_quality-val">0.05</span></div>
                                        <input type="range" id="w-data_quality" min="0" max="0.5" step="0.05" value="0.05" class="slider w-full" oninput="updateWeight('data_quality')">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1">Min Reviews Threshold</label>
                                        <input type="number" id="w-min-reviews" value="5" class="w-full border rounded-lg px-4 py-2">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sentiment Analysis Section -->
                        <div class="mt-6 pt-6 border-t">
                            <h4 class="font-medium mb-4">Review Sentiment Analysis (NLP)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="text-sm font-medium mb-3">Sentiment Statistics</h5>
                                    <div id="sentiment-stats" class="text-sm space-y-2">
                                        <div class="flex justify-between"><span>Total Reviews:</span><span id="stat-total-reviews">-</span></div>
                                        <div class="flex justify-between"><span>With Text:</span><span id="stat-with-text">-</span></div>
                                        <div class="flex justify-between"><span>Avg Sentiment:</span><span id="stat-avg-sentiment">-</span></div>
                                        <div class="flex justify-between text-green-600"><span>Positive:</span><span id="stat-positive">-</span></div>
                                        <div class="flex justify-between text-gray-600"><span>Neutral:</span><span id="stat-neutral">-</span></div>
                                        <div class="flex justify-between text-red-600"><span>Negative:</span><span id="stat-negative">-</span></div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="text-sm font-medium mb-3">Aspect Scores (Avg)</h5>
                                    <div id="aspect-stats" class="text-sm space-y-2">
                                        <div class="flex justify-between"><span>Food:</span><span id="stat-aspect-food">-</span></div>
                                        <div class="flex justify-between"><span>Service:</span><span id="stat-aspect-service">-</span></div>
                                        <div class="flex justify-between"><span>Ambiance:</span><span id="stat-aspect-ambiance">-</span></div>
                                        <div class="flex justify-between"><span>Value:</span><span id="stat-aspect-value">-</span></div>
                                    </div>
                                    <button onclick="loadSentimentStats()" class="mt-3 text-xs text-blue-600 hover:underline">Refresh Stats</button>
                                </div>
                            </div>
                            <div class="mt-4 flex flex-wrap gap-3">
                                <button onclick="reanalyzeReviews()" id="reanalyze-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                    Reanalyze All Reviews with NLP
                                </button>
                                <button onclick="testSentiment()" class="border px-4 py-2 rounded-lg text-sm hover:bg-gray-50">
                                    Test Sentiment Analysis
                                </button>
                            </div>
                            <div id="reanalyze-progress" class="hidden mt-3 bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <span id="reanalyze-status" class="text-sm text-blue-700">Processing...</span>
                            </div>
                        </div>
                        
                        <!-- Custom Keywords Management -->
                        <div class="mt-6 pt-6 border-t">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-medium">Custom Sentiment Keywords</h4>
                                <button onclick="toggleKeywordPanel()" class="text-sm text-blue-600 hover:underline">
                                    <span id="keyword-panel-toggle">Show Keywords</span>
                                </button>
                            </div>
                            
                            <div id="keyword-panel" class="hidden">
                                <!-- Add Keyword Form -->
                                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                    <h5 class="text-sm font-medium mb-3">Add New Keyword</h5>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                        <input type="text" id="new-keyword" placeholder="Keyword or phrase" class="border rounded-lg px-3 py-2 text-sm">
                                        <select id="new-keyword-category" class="border rounded-lg px-3 py-2 text-sm">
                                            <option value="food">Food</option>
                                            <option value="service">Service</option>
                                            <option value="ambiance">Ambiance</option>
                                            <option value="value">Value</option>
                                        </select>
                                        <select id="new-keyword-sentiment" class="border rounded-lg px-3 py-2 text-sm">
                                            <option value="positive">Positive</option>
                                            <option value="negative">Negative</option>
                                        </select>
                                        <button onclick="addKeyword()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                                            Add Keyword
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">Add keywords in any language. They will be matched case-insensitively in review text.</p>
                                </div>
                                
                                <!-- Bulk Add -->
                                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                    <h5 class="text-sm font-medium mb-3">Bulk Add Keywords</h5>
                                    <div class="flex gap-3">
                                        <textarea id="bulk-keywords" placeholder="Enter keywords, one per line" class="flex-1 border rounded-lg px-3 py-2 text-sm h-20"></textarea>
                                        <div class="flex flex-col gap-2">
                                            <select id="bulk-category" class="border rounded-lg px-3 py-2 text-sm">
                                                <option value="food">Food</option>
                                                <option value="service">Service</option>
                                                <option value="ambiance">Ambiance</option>
                                                <option value="value">Value</option>
                                            </select>
                                            <select id="bulk-sentiment" class="border rounded-lg px-3 py-2 text-sm">
                                                <option value="positive">Positive</option>
                                                <option value="negative">Negative</option>
                                            </select>
                                            <button onclick="addBulkKeywords()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                                Add All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Keywords List by Category -->
                                <div class="space-y-4">
                                    <div class="flex gap-2 mb-3">
                                        <button onclick="filterKeywordsByCategory('')" class="keyword-cat-btn px-3 py-1 rounded-lg text-sm bg-spot-burgundy text-white" data-cat="">All</button>
                                        <button onclick="filterKeywordsByCategory('food')" class="keyword-cat-btn px-3 py-1 rounded-lg text-sm border hover:bg-gray-50" data-cat="food">Food</button>
                                        <button onclick="filterKeywordsByCategory('service')" class="keyword-cat-btn px-3 py-1 rounded-lg text-sm border hover:bg-gray-50" data-cat="service">Service</button>
                                        <button onclick="filterKeywordsByCategory('ambiance')" class="keyword-cat-btn px-3 py-1 rounded-lg text-sm border hover:bg-gray-50" data-cat="ambiance">Ambiance</button>
                                        <button onclick="filterKeywordsByCategory('value')" class="keyword-cat-btn px-3 py-1 rounded-lg text-sm border hover:bg-gray-50" data-cat="value">Value</button>
                                    </div>
                                    
                                    <div id="keywords-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <!-- Keywords will be loaded here -->
                                    </div>
                                    
                                    <div id="default-keywords-section" class="mt-4">
                                        <h5 class="text-sm font-medium mb-2 text-gray-500">Default Keywords (Built-in)</h5>
                                        <div id="default-keywords-list" class="text-xs text-gray-400">
                                            <!-- Default keywords shown for reference -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex space-x-4">
                            <button type="submit" class="bg-spot-burgundy text-white px-6 py-2 rounded-lg">Save Weights</button>
                            <button type="button" onclick="recomputeAll()" class="border px-6 py-2 rounded-lg">Recompute All Rankings</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Restaurants -->
            <section id="section-restaurants" class="section hidden">
                <div class="bg-white rounded-xl border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold">Restaurant Database</h3>
                        <div class="flex space-x-2">
                            <button onclick="extractMissingEmails()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                Extract Missing Emails
                            </button>
                            <select id="rest-city-filter" class="border rounded-lg px-3 py-2 text-sm" onchange="loadRestaurants()">
                                <option value="">All Cities</option>
                            </select>
                            <input type="text" id="restaurant-search" placeholder="Search..." class="border rounded-lg px-4 py-2 text-sm" onkeyup="filterRestaurants()">
                        </div>
                    </div>
                    
                    <!-- Email extraction progress -->
                    <div id="email-extract-progress" class="hidden mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span id="email-extract-text" class="text-sm text-blue-700">Extracting emails...</span>
                            <span id="email-extract-count" class="text-sm font-medium text-blue-700">0/0</span>
                        </div>
                        <div class="w-full bg-blue-200 rounded-full h-2">
                            <div id="email-extract-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="text-left text-gray-500 border-b">
                                <tr><th class="pb-2">Rank</th><th class="pb-2">Name</th><th class="pb-2">Region</th><th class="pb-2">Cuisine</th><th class="pb-2">Email</th><th class="pb-2">Phone</th><th class="pb-2">Score</th><th class="pb-2">Status</th></tr>
                            </thead>
                            <tbody id="restaurant-table"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Rankings -->
            <section id="section-rankings" class="section hidden">
                <div class="bg-white rounded-xl border p-6">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <div>
                            <h3 class="font-semibold">Manage Rankings</h3>
                            <p class="text-sm text-gray-500">Shows all restaurants. Filter by city if needed.</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <select id="rank-city" class="border rounded-lg px-3 py-2 text-sm" onchange="loadRankings()">
                                <option value="">All Cities</option>
                            </select>
                            <button onclick="recomputeCity()" class="border px-4 py-2 rounded-lg text-sm hover:bg-gray-50">Recompute</button>
                            <div class="relative">
                                <button onclick="toggleBackupMenu()" class="border px-4 py-2 rounded-lg text-sm hover:bg-gray-50 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Backup
                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="backup-menu" class="hidden absolute right-0 mt-1 w-48 bg-white border rounded-lg shadow-lg z-10">
                                    <button onclick="downloadBackup('json')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Download JSON</button>
                                    <button onclick="downloadBackup('csv')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Download CSV</button>
                                    <hr>
                                    <button onclick="openRestoreModal()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Restore from backup</button>
                                </div>
                            </div>
                            <button onclick="openPublishModal()" class="bg-spot-burgundy text-white px-4 py-2 rounded-lg text-sm">Publish Rankings</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="text-left text-gray-500 border-b">
                                <tr>
                                    <th class="pb-2 w-8"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                    <th class="pb-2">Auto</th><th class="pb-2 w-20">Manual</th><th class="pb-2">Restaurant</th><th class="pb-2">Score</th><th class="pb-2">Reviews</th><th class="pb-2">Status</th>
                                </tr>
                            </thead>
                            <tbody id="rankings-table"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="flex space-x-2">
                            <button onclick="openPublishModal('selected')" class="border px-4 py-2 rounded-lg text-sm hover:bg-gray-50">Publish Selected</button>
                        </div>
                        <div class="text-sm text-gray-500">
                            <span id="selection-count">0</span> selected
                        </div>
                    </div>
                </div>
            </section>

            <!-- Publish Modal -->
            <div id="publish-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold">Publish Rankings</h3>
                        <p class="text-sm text-gray-500 mt-1" id="modal-region-info">City: -</p>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">How many restaurants?</label>
                            <select id="modal-publish-count" class="w-full border rounded-lg px-4 py-2">
                                <option value="selected">Selected only</option>
                                <option value="10">Top 10</option>
                                <option value="20" selected>Top 20</option>
                                <option value="30">Top 30</option>
                                <option value="50">Top 50</option>
                                <option value="100">Top 100</option>
                            </select>
                        </div>
                        <div class="border-t pt-4">
                            <label class="block text-sm font-medium mb-3">What would you like to do?</label>
                            <div class="space-y-3">
                                <button onclick="preApproveOnly()" class="w-full text-left p-4 border rounded-lg hover:bg-gray-50 transition">
                                    <div class="font-medium">Pre-approve only</div>
                                    <div class="text-sm text-gray-500">Mark as ready for publication. You can push to website later.</div>
                                </button>
                                <button onclick="openConfirmPushModal()" class="w-full text-left p-4 border rounded-lg hover:bg-spot-burgundy/10 border-spot-burgundy/30 transition">
                                    <div class="font-medium text-spot-burgundy">Push directly to website</div>
                                    <div class="text-sm text-gray-500">Pre-approve AND send to your website immediately. Welcome emails will be sent.</div>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t bg-gray-50 rounded-b-xl">
                        <button onclick="closePublishModal()" class="w-full border px-4 py-2 rounded-lg hover:bg-gray-100">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Confirm Push Modal -->
            <div id="confirm-push-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
                    <div class="p-6 border-b bg-orange-50">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-orange-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            <h3 class="text-lg font-semibold text-orange-700">Confirm Push to Website</h3>
                        </div>
                    </div>
                    <div class="p-6">
                        <p class="mb-4">Are you sure you want to push these rankings to your website?</p>
                        <div class="bg-gray-50 rounded-lg p-4 text-sm space-y-2">
                            <div class="flex justify-between"><span class="text-gray-500">City:</span><span class="font-medium" id="confirm-region">-</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Restaurants:</span><span class="font-medium" id="confirm-count">-</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Welcome emails:</span><span class="font-medium text-green-600">Will be sent to new listings</span></div>
                        </div>
                        <p class="mt-4 text-sm text-gray-500">This action will update your live website. Make sure you've reviewed the rankings.</p>
                    </div>
                    <div class="p-4 border-t bg-gray-50 rounded-b-xl flex space-x-3">
                        <button onclick="closeConfirmPushModal()" class="flex-1 border px-4 py-2 rounded-lg hover:bg-gray-100">Cancel</button>
                        <button onclick="executePush()" class="flex-1 bg-spot-burgundy text-white px-4 py-2 rounded-lg hover:bg-spot-burgundy hover:opacity-90">Yes, Push Now</button>
                    </div>
                </div>
            </div>

            <!-- Restore Modal -->
            <div id="restore-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold">Restore from Backup</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-sm text-gray-500 mb-4">Upload a JSON backup file to restore manual rankings and admin notes.</p>
                        <input type="file" id="restore-file" accept=".json" class="w-full border rounded-lg px-4 py-2">
                        <p class="text-xs text-gray-400 mt-2">Note: This only restores manual_rank and admin_notes fields. Restaurant data is not affected.</p>
                    </div>
                    <div class="p-4 border-t bg-gray-50 rounded-b-xl flex space-x-3">
                        <button onclick="closeRestoreModal()" class="flex-1 border px-4 py-2 rounded-lg hover:bg-gray-100">Cancel</button>
                        <button onclick="executeRestore()" class="flex-1 bg-spot-burgundy text-white px-4 py-2 rounded-lg hover:bg-spot-burgundy hover:opacity-90">Restore</button>
                    </div>
                </div>
            </div>

            <!-- Website Push -->
            <section id="section-website" class="section hidden">
                <!-- Simple URL Analyzer -->
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-2">Analyze Your Website Structure</h3>
                    <p class="text-sm text-gray-500 mb-4">Enter a URL to your website's restaurant data (API endpoint or page). We'll automatically detect the structure and create field mappings.</p>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="analyze-url" class="flex-1 border rounded-lg px-4 py-2" placeholder="https://yoursite.com/api/restaurants or https://yoursite.com/restaurants">
                        <button onclick="analyzeWebsiteUrl()" id="analyze-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Analyze</button>
                    </div>
                    
                    <!-- Analysis Results -->
                    <div id="schema-results" class="hidden">
                        <div class="border-t pt-4 mt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium">Detected Structure</h4>
                                <span id="schema-status" class="text-sm px-2 py-1 rounded bg-green-100 text-green-700">Detected</span>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-xs text-gray-500 mb-1">Data Type</div>
                                    <div id="detected-type" class="font-medium">-</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-xs text-gray-500 mb-1">Records Found</div>
                                    <div id="detected-count" class="font-medium">-</div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-sm font-medium mb-2">Fields Detected (<span id="field-count">0</span>)</div>
                                <div id="detected-fields" class="flex flex-wrap gap-2"></div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-sm font-medium mb-2">Auto-Generated Mapping</div>
                                <div class="overflow-x-auto max-h-60 overflow-y-auto">
                                    <table class="w-full text-sm">
                                        <thead class="text-left text-gray-500 border-b sticky top-0 bg-white">
                                            <tr>
                                                <th class="pb-2">Your Field</th>
                                                <th class="pb-2">Mapped To (Spotwego)</th>
                                                <th class="pb-2">Sample Value</th>
                                            </tr>
                                        </thead>
                                        <tbody id="mapping-table"></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="applyDetectedMapping()" class="bg-spot-burgundy text-white px-4 py-2 rounded-lg">Apply This Mapping</button>
                                <button onclick="toggleRawData()" class="border px-4 py-2 rounded-lg">View Raw Data</button>
                            </div>
                            
                            <div id="raw-data-panel" class="hidden mt-4">
                                <pre id="raw-data" class="text-xs bg-gray-100 p-3 rounded overflow-x-auto max-h-60"></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Mapping Status -->
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="font-semibold">Current Field Mapping</h3>
                            <p class="text-sm text-gray-500">How Spotwego data maps to your website</p>
                        </div>
                        <button onclick="clearFieldMapping()" class="text-sm text-red-500 hover:underline">Clear Mapping</button>
                    </div>
                    <div id="current-mapping-display" class="text-sm text-gray-500">No mapping configured. Analyze a URL above to auto-detect.</div>
                </div>

                <div class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-4">Website API Configuration</h3>
                    <form onsubmit="saveWebsiteConfig(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">API Base URL</label>
                            <input type="text" id="ws-url" class="w-full border rounded-lg px-4 py-2" placeholder="https://yourwebsite.com">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Push Endpoint</label>
                                <input type="text" id="ws-endpoint" class="w-full border rounded-lg px-4 py-2" value="/api/restaurants/import">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">API Key</label>
                                <input type="password" id="ws-key" class="w-full border rounded-lg px-4 py-2" placeholder="Bearer token">
                            </div>
                        </div>
                        <button type="submit" class="bg-spot-burgundy text-white px-6 py-2 rounded-lg">Save Configuration</button>
                    </form>
                </div>
                
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-4">Push by Region</h3>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="block text-sm mb-1">Region</label>
                            <select id="push-city" class="border rounded-lg px-4 py-2"></select>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Count</label>
                            <select id="push-count" class="border rounded-lg px-4 py-2">
                                <option value="10">Top 10</option>
                                <option value="20" selected>Top 20</option>
                                <option value="30">Top 30</option>
                                <option value="50">Top 50</option>
                            </select>
                        </div>
                        <button onclick="pushRegionFromWebsite()" class="bg-spot-maroon text-white px-6 py-2 rounded-lg">Push Now</button>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl border p-6">
                    <h3 class="font-semibold mb-4">Push History</h3>
                    <div id="push-history" class="space-y-2 text-sm"></div>
                </div>
            </section>

            <!-- Email Notifications -->
            <section id="section-emails" class="section hidden">
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-4">Email Configuration (SMTP)</h3>
                    <form onsubmit="saveEmailConfig(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">SMTP Host</label>
                                <input type="text" id="email-smtp-host" class="w-full border rounded-lg px-4 py-2" value="smtp.gmail.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">SMTP Port</label>
                                <input type="number" id="email-smtp-port" class="w-full border rounded-lg px-4 py-2" value="587">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">SMTP Username (Email)</label>
                                <input type="email" id="email-smtp-user" class="w-full border rounded-lg px-4 py-2" placeholder="your@gmail.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">SMTP Password / App Password</label>
                                <input type="password" id="email-smtp-password" class="w-full border rounded-lg px-4 py-2" placeholder="••••••••">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">From Name</label>
                                <input type="text" id="email-from-name" class="w-full border rounded-lg px-4 py-2" value="Spotwego">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Reply-To Email</label>
                                <input type="email" id="email-reply-to" class="w-full border rounded-lg px-4 py-2" placeholder="support@yoursite.com">
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button type="submit" class="bg-spot-burgundy text-white px-6 py-2 rounded-lg">Save Configuration</button>
                            <label class="flex items-center">
                                <input type="checkbox" id="email-active" checked class="mr-2">
                                <span class="text-sm">Enable email sending</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500">For Gmail, use an App Password (not your regular password). Go to Google Account → Security → 2-Step Verification → App passwords.</p>
                    </form>
                    
                    <!-- Test Email Section -->
                    <div class="mt-6 pt-6 border-t">
                        <h4 class="font-medium mb-3"> Test Email Configuration</h4>
                        <div class="flex items-end gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium mb-1">Send test email to:</label>
                                <input type="email" id="test-email-recipient" class="w-full border rounded-lg px-4 py-2" placeholder="your-email@example.com">
                            </div>
                            <button onclick="sendTestEmail()" id="test-email-btn" class="bg-spot-maroon text-white px-6 py-2 rounded-lg hover:opacity-90 transition whitespace-nowrap">
                                 Send Test Email
                            </button>
                        </div>
                        <div id="test-email-status" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
                        <p class="text-xs text-gray-500 mt-2">Sends a test email using your current SMTP configuration. Make sure to save the configuration first!</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-4">Welcome Email Template</h3>
                    <form onsubmit="saveEmailTemplate(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Subject</label>
                            <input type="text" id="template-subject" class="w-full border rounded-lg px-4 py-2" value="Congratulations! Your restaurant is now featured on our platform">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email Body (HTML)</label>
                            <textarea id="template-body" rows="12" class="w-full border rounded-lg px-4 py-2 font-mono text-sm"><html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <div style="background: #6B4444; padding: 20px; text-align: center;">
        <h1 style="color: white; margin: 0; font-family: Georgia, serif; font-style: italic;">Spotwego</h1>
    </div>
    <div style="padding: 30px; background: #FAF7F5;">
        <h2 style="color: #3D2929;">Congratulations, {{contact_name}}!</h2>
        <p style="color: #3D2929;">We're excited to inform you that <strong>{{restaurant_name}}</strong> has been selected to be featured on Spotwego!</p>
        <p style="color: #3D2929;">Your restaurant was chosen based on:</p>
        <ul style="color: #6B4444;">
            <li>Excellent customer reviews</li>
            <li>Quality of service</li>
            <li>Positive sentiment analysis</li>
        </ul>
        <p style="color: #3D2929;">This means increased visibility to food enthusiasts looking for the best dining experiences in {{city}}.</p>
        <p style="color: #3D2929;">Best regards,<br><strong>The Spotwego Team</strong></p>
    </div>
    <div style="background: #6B4444; padding: 15px; text-align: center; color: #C4A4A4; font-size: 12px;">
        © 2025 Spotwego. All rights reserved.
    </div>
</body>
</html></textarea>
                        </div>
                        <div class="flex items-center space-x-2 text-sm text-gray-500">
                            <span>Available variables:</span>
                            <code class="bg-gray-100 px-2 py-1 rounded">{{restaurant_name}}</code>
                            <code class="bg-gray-100 px-2 py-1 rounded">{{contact_name}}</code>
                            <code class="bg-gray-100 px-2 py-1 rounded">{{city}}</code>
                            <code class="bg-gray-100 px-2 py-1 rounded">{{address}}</code>
                        </div>
                        <button type="submit" class="bg-spot-burgundy text-white px-6 py-2 rounded-lg">Save Template</button>
                    </form>
                </div>
                
                <!-- Email Approval Queue -->
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="font-semibold"> Email Approval Queue</h3>
                            <p class="text-sm text-gray-500">Review and approve emails before they are sent to restaurants</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="queuePendingEmails()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-200">
                                 Queue New Emails
                            </button>
                            <button onclick="sendApprovedEmails()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                                 Send Approved
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                        <p class="text-sm text-amber-800">
                            <strong> Manual Approval Required:</strong> All emails to restaurants must be approved before sending. 
                            Test emails (to verify SMTP) bypass this restriction.
                        </p>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="text-left text-gray-500 border-b">
                                <tr>
                                    <th class="pb-2 w-8"><input type="checkbox" id="select-all-emails" onchange="toggleAllEmails(this)"></th>
                                    <th class="pb-2">Restaurant</th>
                                    <th class="pb-2">Email To</th>
                                    <th class="pb-2">City</th>
                                    <th class="pb-2">Status</th>
                                    <th class="pb-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="email-queue-table">
                                <tr><td colspan="6" class="py-4 text-center text-gray-400">No emails in queue</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex gap-2">
                        <button onclick="approveSelectedEmails()" class="bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm hover:bg-green-200">
                            Approve Selected
                        </button>
                        <button onclick="rejectSelectedEmails()" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg text-sm hover:bg-red-200">
                            X Reject Selected
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl border p-6">
                    <h3 class="font-semibold mb-4"> Email History</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="text-left text-gray-500 border-b">
                                <tr><th class="pb-2">Restaurant</th><th class="pb-2">To</th><th class="pb-2">Subject</th><th class="pb-2">Status</th><th class="pb-2">Date</th></tr>
                            </thead>
                            <tbody id="email-log-table"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Daily Automation -->
            <section id="section-automation" class="section hidden">
                <div class="bg-white rounded-xl border p-6 mb-6">
                    <h3 class="font-semibold mb-4">Daily Automation</h3>
                    <p class="text-sm text-gray-500 mb-4">Configure automatic daily ranking updates and pushes per city.</p>
                    
                    <div class="p-4 bg-blue-50 rounded-lg mb-6">
                        <h4 class="font-medium mb-2">How it works</h4>
                        <ol class="text-sm space-y-1 list-decimal list-inside">
                            <li>User reviews from your website are added via API</li>
                            <li>Daily task recomputes rankings for all cities</li>
                            <li>Cities with "Auto Push" enabled are automatically pushed to your website</li>
                        </ol>
                    </div>
                    
                    <button onclick="runDailyTasks()" class="bg-spot-burgundy text-white px-6 py-2 rounded-lg mb-6">Run Daily Tasks Now</button>
                    
                    <h4 class="font-medium mb-4">Region Auto-Push Settings</h4>
                    <div id="city-auto-settings" class="space-y-3"></div>
                </div>
                
                <div class="bg-white rounded-xl border p-6">
                    <h3 class="font-semibold mb-4">Cron Job / Scheduler Setup</h3>
                    <p class="text-sm text-gray-500 mb-4">Call this endpoint daily from your scheduler:</p>
                    <code class="block p-4 bg-gray-800 text-green-400 rounded text-sm mb-4">
                        POST {window.location.origin}/api/daily/run
                    </code>
                    <p class="text-sm text-gray-500">Example with cURL:</p>
                    <code class="block p-4 bg-gray-800 text-green-400 rounded text-sm">
                        curl -X POST {window.location.origin}/api/daily/run
                    </code>
                </div>
            </section>

            <!-- User Reviews API -->
            <section id="section-user-reviews" class="section hidden">
                <div class="bg-white rounded-xl border p-6">
                    <h3 class="font-semibold mb-4">User Reviews API</h3>
                    <p class="text-sm text-gray-500 mb-4">Receive reviews from your website users</p>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <h4 class="font-medium mb-2">Endpoint</h4>
                            <code class="block p-3 bg-gray-800 text-green-400 rounded text-sm">POST {window.location.origin}/api/reviews/user</code>
                        </div>
                        
                        <h4 class="font-medium">Request Body</h4>
                        <pre class="p-4 bg-gray-800 text-green-400 rounded text-sm overflow-x-auto">{
  "restaurant_id": 123,      // OR restaurant_name
  "restaurant_name": "Le Chat-Botté",
  "rating": 4.5,             // 1-5
  "review_text": "Great!",
  "reviewer_name": "John",   // optional
  "user_id": "user123",      // optional
  "verified": 1              // optional (0 or 1)
}</pre>
                        
                        <h4 class="font-medium">Response</h4>
                        <pre class="p-4 bg-gray-800 text-green-400 rounded text-sm overflow-x-auto">{
  "success": true,
  "review_id": 456,
  "region_code": "geneva"
}</pre>
                    </div>
                </div>
            </section>

            <!-- Health Check -->
            <section id="section-health-check" class="section hidden">
                <div class="bg-white rounded-xl border p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="font-semibold text-xl">System Health Check</h3>
                            <p class="text-sm text-gray-500">Comprehensive diagnostic for all system components</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="runFullHealthCheck()" id="health-check-btn" class="bg-spot-burgundy text-white px-6 py-2 rounded-lg hover:opacity-90">
                                Run Full Check
                            </button>
                            <button onclick="runFrontendChecks()" class="border px-4 py-2 rounded-lg hover:bg-gray-50">
                                Frontend Only
                            </button>
                        </div>
                    </div>
                    
                    <!-- Overall Status -->
                    <div id="health-overall" class="mb-6 p-4 rounded-lg bg-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div id="health-status-icon" class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <div>
                                    <div id="health-status-text" class="text-lg font-semibold">Click "Run Full Check" to start</div>
                                    <div id="health-timestamp" class="text-sm text-gray-500">Last check: Never</div>
                                </div>
                            </div>
                            <div id="health-summary" class="text-right hidden">
                                <div class="flex gap-4">
                                    <div><span id="health-passed" class="text-2xl font-bold text-green-600">0</span><span class="text-sm text-gray-500 ml-1">passed</span></div>
                                    <div><span id="health-warnings" class="text-2xl font-bold text-amber-500">0</span><span class="text-sm text-gray-500 ml-1">warnings</span></div>
                                    <div><span id="health-failed" class="text-2xl font-bold text-red-600">0</span><span class="text-sm text-gray-500 ml-1">failed</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress -->
                    <div id="health-progress" class="hidden mb-6">
                        <div class="flex items-center gap-3">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-spot-burgundy"></div>
                            <span id="health-progress-text" class="text-sm text-gray-600">Running checks...</span>
                        </div>
                    </div>
                    
                    <!-- Results Grid -->
                    <div id="health-results" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Results will be loaded here -->
                        <div class="col-span-2 text-center text-gray-400 py-8">
                            Run a health check to see results
                        </div>
                    </div>
                    
                    <!-- Frontend Checks -->
                    <div id="frontend-checks" class="mt-6 hidden">
                        <h4 class="font-medium mb-3">Frontend Function Tests</h4>
                        <div id="frontend-results" class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <!-- Frontend results -->
                        </div>
                    </div>
                    
                    <!-- Raw JSON Output -->
                    <div class="mt-6">
                        <button onclick="toggleHealthJson()" class="text-sm text-blue-600 hover:underline">Show Raw JSON</button>
                        <pre id="health-json" class="hidden mt-2 p-3 bg-gray-900 text-gray-100 rounded-lg text-xs overflow-x-auto max-h-96 overflow-y-auto"></pre>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all z-50 pointer-events-none"></div>

<script>
const API = '';
let citiesData = [];
let restaurantsData = [];
let map = null;

// ========== NAVIGATION ==========

function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    document.getElementById(`section-${id}`).classList.remove('hidden');
    document.querySelectorAll('.sidebar-link').forEach(l => {
        l.classList.remove('active');
        if (l.dataset.section === id) l.classList.add('active');
    });
    const titles = {
        'dashboard': 'Dashboard', 'map': 'Region Map', 'api-keys': 'API Keys',
        'cost-analytics': 'Cost Analytics', 'scraping': 'Data Collection', 'model': 'Model Weights',
        'restaurants': 'Restaurants', 'rankings': 'Rankings', 'website': 'Website Push',
        'emails': 'Email Notifications', 'automation': 'Daily Automation', 'user-reviews': 'User Reviews API',
        'health-check': 'System Health Check'
    };
    document.getElementById('pageTitle').textContent = titles[id] || 'Dashboard';
    
    if (id === 'map') initMap();
    if (id === 'api-keys') loadApiKeys();
    if (id === 'cost-analytics') loadCostAnalytics();
    if (id === 'scraping') loadJobs();
    if (id === 'model') loadWeights();
    if (id === 'restaurants') loadRestaurants();
    if (id === 'rankings') loadRankings();
    if (id === 'website') { loadWebsiteConfig(); loadPushHistory(); }
    if (id === 'emails') { loadEmailConfig(); loadEmailQueue(); loadEmailLog(); }
    if (id === 'automation') loadAutomationSettings();
}

// ========== COST ANALYTICS ==========

async function loadCostAnalytics() {
    console.log('loadCostAnalytics called at', new Date().toISOString());
    
    // Check if cost analytics elements exist (tab might not be loaded yet)
    const costTodayEl = document.getElementById('cost-today');
    if (!costTodayEl) {
        console.log('Cost analytics elements not in DOM yet');
        return;
    }
    
    const period = document.getElementById('cost-period')?.value || 'week';
    
    try {
        const res = await fetch(`${API}/api/costs?period=${period}`);
        const data = await res.json();
        console.log('Cost data received:', data);
        
        // Update summary cards (with null checks)
        if (document.getElementById('cost-today')) {
            document.getElementById('cost-today').textContent = '$' + (data.today_cost || 0).toFixed(2);
        }
        if (document.getElementById('cost-month')) {
            document.getElementById('cost-month').textContent = '$' + (data.month_cost || 0).toFixed(2);
        }
        if (document.getElementById('cost-calls')) {
            document.getElementById('cost-calls').textContent = (data.total_calls || 0).toLocaleString();
        }
        if (document.getElementById('cost-total')) {
            document.getElementById('cost-total').textContent = '$' + (data.total_cost || 0).toFixed(2);
        }
        
        // Update breakdown table
        const breakdownTable = document.getElementById('cost-breakdown-table');
        if (breakdownTable) {
            const breakdownHtml = (data.breakdown || []).map(b => `
                <tr class="border-b">
                    <td class="py-2 font-medium">${b.endpoint}</td>
                    <td class="py-2">${b.provider}</td>
                    <td class="py-2">${b.request_count.toLocaleString()}</td>
                    <td class="py-2">$${b.cost_per_call.toFixed(4)}</td>
                    <td class="py-2 font-medium text-spot-burgundy">$${b.total_cost.toFixed(2)}</td>
                </tr>
            `).join('');
            breakdownTable.innerHTML = breakdownHtml || 
                '<tr><td colspan="5" class="py-4 text-center text-gray-400">No API usage recorded yet</td></tr>';
        }
        
        // Update history table
        const historyTable = document.getElementById('cost-history-table');
        if (historyTable) {
            const historyHtml = (data.history || []).map(h => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-2 text-gray-500">${formatDateTime(h.timestamp)}</td>
                    <td class="py-2">${h.endpoint}</td>
                    <td class="py-2">${h.provider}</td>
                    <td class="py-2">${h.request_count}</td>
                    <td class="py-2 font-medium ${h.estimated_cost > 0 ? 'text-amber-600' : 'text-green-600'}">
                        ${h.estimated_cost > 0 ? '$' + h.estimated_cost.toFixed(4) : 'FREE'}
                    </td>
                </tr>
            `).join('');
            historyTable.innerHTML = historyHtml || 
                '<tr><td colspan="5" class="py-4 text-center text-gray-400">No history available</td></tr>';
        }
        
        // Update last refreshed timestamp
        const lastUpdatedEl = document.getElementById('cost-last-updated');
        if (lastUpdatedEl) {
            lastUpdatedEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
        }
            
    } catch (err) {
        console.error('Failed to load cost analytics:', err);
    }
    
    calculateEstimate();
}

function formatDateTime(isoString) {
    if (!isoString) return '-';
    const d = new Date(isoString);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function calculateEstimate() {
    const operationEl = document.getElementById('estimate-operation');
    const countEl = document.getElementById('estimate-count');
    const resultEl = document.getElementById('estimate-result');
    
    // Skip if elements don't exist
    if (!operationEl || !countEl || !resultEl) return;
    
    const operation = operationEl.value;
    const count = parseInt(countEl.value) || 0;
    
    let cost = 0;
    
    if (operation === 'preview') {
        // Quick Preview is FREE (basic fields only)
        cost = 0;
    } else if (operation === 'details') {
        // Fetch Details + Contact: ~$0.020 per place
        cost = count * 0.020;
    } else if (operation === 'full') {
        // Full Search + Import: Preview (free) + Details ($0.020 each)
        cost = count * 0.020;
    }
    
    resultEl.textContent = '$' + cost.toFixed(2);
}

async function clearCostHistory() {
    if (!confirm('Clear all API usage history? This cannot be undone.')) return;
    
    try {
        await fetch(`${API}/api/costs/clear`, { method: 'POST' });
        showToast('Cost history cleared');
        loadCostAnalytics();
    } catch (err) {
        showToast('Error clearing history', 'error');
    }
}

// Track API usage (called from other functions)
async function trackApiUsage(provider, endpoint, requestCount, estimatedCost) {
    try {
        await fetch(`${API}/api/costs/track`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                provider,
                endpoint,
                request_count: requestCount,
                estimated_cost: estimatedCost
            })
        });
    } catch (err) {
        console.error('Failed to track API usage:', err);
    }
}

// ========== REGIONS ==========

async function loadCities() {
    const res = await fetch(`${API}/api/regions`);
    citiesData = await res.json();
    
    // Populate all region dropdowns
    const selects = ['globalCity', 'rest-city-filter', 'rank-city', 'push-city'];
    selects.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            const current = el.value;
            el.innerHTML = '<option value="">All Cities</option>' + citiesData.map(r => 
                `<option value="${r.code}">${r.name}</option>`
            ).join('');
            el.value = current;
        }
    });
}

function onRegionChange() {
    const region = document.getElementById('globalCity').value;
    // Sync all region selects
    ['rest-city-filter', 'rank-city', 'push-city'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = region;
    });
}

async function initMap() {
    if (!map) {
        map = L.map('map').setView([46.8, 8.2], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);
    }
    
    await loadCities();
    
    map.eachLayer(l => { if (l instanceof L.CircleMarker) map.removeLayer(l); });
    
    const colors = { fresh: '#22c55e', stale: '#f59e0b', old: '#ef4444', never: '#9ca3af' };
    
    citiesData.forEach(r => {
        if (r.latitude && r.longitude) {
            const color = colors[r.freshness] || colors.never;
            const size = Math.min(25, 10 + (r.restaurants_count || 0) / 5);
            L.circleMarker([r.latitude, r.longitude], {
                radius: size, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.8
            }).addTo(map).bindPopup(`
                <b>${r.name}</b><br>
                Restaurants: ${r.restaurants_count || 0}<br>
                Status: <span class="${r.freshness}">${r.freshness}</span><br>
                Last scan: ${r.days_since_scan !== null ? r.days_since_scan + ' days ago' : 'Never'}
            `);
        }
    });
    
    const listHtml = citiesData.map(r => `
        <div class="p-4 border rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <span class="font-medium">${r.name}</span>
                <span class="w-3 h-3 rounded-full bg-${r.freshness}"></span>
            </div>
            <div class="text-sm text-gray-500">${r.restaurants_count || 0} restaurants</div>
            <div class="text-xs text-gray-400 mb-2">${r.days_since_scan !== null ? r.days_since_scan + ' days ago' : 'Never scanned'}</div>
            <button onclick="collectRegion('${r.name}')" class="text-xs text-spot-burgundy hover:underline">Refresh Data</button>
        </div>
    `).join('');
    document.getElementById('cities-list').innerHTML = listHtml || '<p class="text-gray-400">No cities yet. Run a data collection to add cities.</p>';
}

async function addRegion(e) {
    e.preventDefault();
    const name = document.getElementById('new-city-name').value;
    await fetch(`${API}/api/regions`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            code: name.toLowerCase().replace(/\s+/g, '_'),
            name: name,
            latitude: parseFloat(document.getElementById('new-city-lat').value) || null,
            longitude: parseFloat(document.getElementById('new-city-lng').value) || null
        })
    });
    document.getElementById('new-city-name').value = '';
    initMap();
    showToast('Region added');
}

function collectRegion(name) {
    document.getElementById('scrape-location').value = name;
    showSection('scraping');
}

// Helper to refresh map if currently visible
function refreshMapIfVisible() {
    const mapSection = document.getElementById('section-map');
    if (mapSection && !mapSection.classList.contains('hidden')) {
        initMap();
    }
}

// Helper to refresh all data displays
async function refreshAllDataDisplays() {
    try {
        await loadDashboard();
        await loadCities();
        await loadCostAnalytics();
        refreshMapIfVisible();
    } catch (err) {
        console.error('Error refreshing displays:', err);
    }
}

// ========== DASHBOARD ==========

async function loadDashboard() {
    console.log('loadDashboard called at', new Date().toISOString());
    
    try {
        const res = await fetch(`${API}/api/stats`);
        const data = await res.json();
        console.log('Dashboard stats received:', data);
        
        // Update stats with null checks
        const statEls = {
            'stat-restaurants': data.restaurants,
            'stat-cities': data.regions || 0,
            'stat-reviews': data.reviews,
            'stat-user-reviews': data.user_reviews || 0,
            'stat-published': data.published,
            'stat-pushed': data.pushed || 0
        };
        
        for (const [id, value] of Object.entries(statEls)) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }
        
        const recentJobsEl = document.getElementById('recent-jobs');
        if (recentJobsEl) {
            const jobsHtml = data.recent_jobs?.length ? data.recent_jobs.map(j => `
                <div class="flex justify-between py-2 border-b last:border-0">
                    <span>${j.region_code || j.location || 'Scan'}</span>
                    <span class="text-xs px-2 py-1 rounded-full ${j.status === 'completed' ? 'bg-green-100 text-green-700' : j.status === 'failed' ? 'bg-red-100 text-red-700' : 'bg-gray-100'}">${j.status}</span>
                </div>
            `).join('') : '<div class="text-gray-400">No recent jobs</div>';
            recentJobsEl.innerHTML = jobsHtml;
        }
        
        // Load API cost for dashboard
        try {
            const costRes = await fetch(`${API}/api/costs?period=month`);
            const costData = await costRes.json();
            console.log('Dashboard API cost received:', costData);
            const apiCostEl = document.getElementById('stat-api-cost');
            if (apiCostEl) {
                apiCostEl.textContent = '$' + (costData.month_cost || 0).toFixed(2);
            }
        } catch (costErr) {
            console.log('Could not load API cost:', costErr);
        }
        
        await loadCities();
    } catch (err) {
        console.error('Failed to load dashboard:', err);
    }
}

// ========== API KEYS ==========

async function loadApiKeys() {
    const res = await fetch(`${API}/api/keys`);
    const keys = await res.json();
    const html = keys.map(k => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg" id="api-key-${k.provider}">
            <div class="flex items-center flex-1">
                <span class="w-10 h-10 rounded-lg bg-spot-burgundy/20 flex items-center justify-center font-bold mr-3">${k.provider[0].toUpperCase()}</span>
                <div class="flex-1">
                    <div class="font-medium capitalize">${k.provider}</div>
                    ${k.is_configured ? `
                        <div class="text-sm text-gray-500 font-mono blur-sm hover:blur-none transition-all cursor-pointer" title="Hover to reveal">
                            ${k.key_preview || '••••••••'}
                        </div>
                    ` : `
                        <div class="text-sm text-orange-500">Not configured</div>
                    `}
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="health-${k.provider}" class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-500">
                    Unknown
                </span>
                ${k.is_configured ? `
                    <button onclick="checkApiHealth('${k.provider}')" class="text-xs border px-2 py-1 rounded hover:bg-white" title="Test API">
                        Test
                    </button>
                    <button onclick="toggleKey('${k.provider}')" class="text-sm border px-3 py-1 rounded ${k.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                        ${k.is_active ? 'Active' : 'Disabled'}
                    </button>
                    <button onclick="deleteApiKey('${k.provider}')" class="text-sm border border-red-300 px-3 py-1 rounded text-red-600 hover:bg-red-50" title="Delete this key">
                        Delete
                    </button>
                ` : `
                    <span class="text-xs text-gray-400">Add key below</span>
                `}
            </div>
        </div>
    `).join('');
    document.getElementById('api-keys-list').innerHTML = html;
}

async function checkApiHealth(provider) {
    const healthEl = document.getElementById(`health-${provider}`);
    healthEl.className = 'text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 animate-pulse';
    healthEl.textContent = 'Testing...';
    
    try {
        const res = await fetch(`${API}/api/keys/${provider}/health`);
        const data = await res.json();
        
        if (data.status === 'healthy') {
            healthEl.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-700';
            healthEl.textContent = 'Healthy';
            healthEl.title = data.message;
        } else if (data.status === 'error') {
            healthEl.className = 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-700';
            healthEl.textContent = 'Error';
            healthEl.title = data.message;
            showToast(`${provider}: ${data.message}`, 'error');
        } else if (data.status === 'not_configured') {
            healthEl.className = 'text-xs px-2 py-1 rounded-full bg-orange-100 text-orange-700';
            healthEl.textContent = 'Not Set';
            healthEl.title = data.message;
        } else {
            healthEl.className = 'text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-700';
            healthEl.textContent = 'Warning';
            healthEl.title = data.message;
        }
    } catch (err) {
        healthEl.className = 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-700';
        healthEl.textContent = 'Failed';
        healthEl.title = err.message;
    }
}

async function checkAllApiHealth() {
    const providers = ['google', 'yelp', 'tripadvisor'];
    for (const p of providers) {
        await checkApiHealth(p);
    }
    showToast('Health check complete');
}

async function saveApiKey(e) {
    e.preventDefault();
    await fetch(`${API}/api/keys`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ provider: document.getElementById('key-provider').value, api_key: document.getElementById('key-value').value })
    });
    document.getElementById('key-value').value = '';
    loadApiKeys();
    showToast('API key saved');
}

async function toggleKey(p) {
    await fetch(`${API}/api/keys/${p}/toggle`, {method: 'POST'});
    loadApiKeys();
}

async function deleteApiKey(provider) {
    if (!confirm(`Are you sure you want to delete the ${provider} API key? This cannot be undone.`)) {
        return;
    }
    
    try {
        const res = await fetch(`${API}/api/keys/${provider}`, {method: 'DELETE'});
        const data = await res.json();
        
        if (data.success) {
            showToast(`${provider} API key deleted`);
            loadApiKeys();
        } else {
            showToast(`Failed to delete: ${data.error}`, 'error');
        }
    } catch (e) {
        showToast(`Error: ${e.message}`, 'error');
    }
}

// ========== DATA COLLECTION ==========

let searchMode = 'cost'; // 'cost' or 'quick'

function setSearchMode(mode) {
    searchMode = mode;
    
    // Update buttons
    document.getElementById('mode-cost').className = mode === 'cost' 
        ? 'px-4 py-2 rounded-lg font-medium bg-spot-burgundy text-white'
        : 'px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700';
    document.getElementById('mode-quick').className = mode === 'quick'
        ? 'px-4 py-2 rounded-lg font-medium bg-purple-600 text-white'
        : 'px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700';
    
    // Show/hide panels
    document.getElementById('cost-mode-info').classList.toggle('hidden', mode !== 'cost');
    document.getElementById('quick-mode-info').classList.toggle('hidden', mode !== 'quick');
    document.getElementById('cost-search-panel').classList.toggle('hidden', mode !== 'cost');
    document.getElementById('quick-search-panel').classList.toggle('hidden', mode !== 'quick');
    
    // Hide results panel when switching modes
    document.getElementById('search-results-panel').classList.add('hidden');
}

async function quickSearchDirect(e) {
    e.preventDefault();
    
    const city = document.getElementById('quick-city').value;
    const country = document.getElementById('quick-country').value;
    const minRating = parseFloat(document.getElementById('quick-min-rating').value);
    const maxResults = parseInt(document.getElementById('quick-max-results').value);
    
    const btn = document.getElementById('quick-search-btn');
    btn.innerHTML = '<span class="animate-pulse">Searching...</span>';
    btn.disabled = true;
    
    try {
        // Use the details endpoint directly with filter
        const res = await fetch(`${API}/api/places/quick-search`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                city: city,
                country: country,
                min_rating: minRating,
                max_results: maxResults
            })
        });
        const data = await res.json();
        
        if (data.success) {
            // Store results and mark as having full details
            searchResults = data.results;
            currentCity = city;
            currentCountry = country;
            previewMode = false; // Already has full details
            
            // Display using the same preview display but mark as ready to import
            displayPreviewResults({
                success: true,
                results: data.results,
                total_found: data.results.length,
                has_details: true
            });
            
            showToast(`Found ${data.results.length} restaurants with ${minRating}+ rating`);
            await loadCostAnalytics();
        } else {
            showToast('Search failed: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    } finally {
        btn.innerHTML = 'Search & Fetch';
        btn.disabled = false;
    }
}

// ========== SEARCH & IMPORT (2-Step Cost Optimized) ==========

let searchResults = [];
let previewMode = true;  // true = basic preview, false = full details loaded
let currentCity = '';
let currentCountry = '';

// Step 1: Quick Preview (FREE - Basic fields only)
async function quickPreview(e) {
    e.preventDefault();
    currentCity = document.getElementById('search-city').value;
    currentCountry = document.getElementById('search-country').value;
    const radius = document.getElementById('search-radius').value;
    const maxResults = document.getElementById('search-max-results').value;
    
    document.getElementById('preview-btn').innerHTML = '<span class="animate-pulse">Searching...</span>';
    document.getElementById('preview-btn').disabled = true;
    
    try {
        const res = await fetch(`${API}/api/places/preview`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                city: currentCity,
                country: currentCountry,
                radius: parseInt(radius),
                max_results: parseInt(maxResults)
            })
        });
        const data = await res.json();
        
        if (data.success) {
            searchResults = data.results;
            previewMode = true;
            displayPreviewResults(data);
            showToast(`Found ${data.total_found} restaurants (FREE preview)`);
            await loadCostAnalytics();  // Refresh to show FREE API calls
        } else {
            showToast('Error: ' + (data.error || 'Search failed'), 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    } finally {
        document.getElementById('preview-btn').innerHTML = 'Quick Preview (FREE)';
        document.getElementById('preview-btn').disabled = false;
    }
}

// Display preview results (basic info only)
function displayPreviewResults(data) {
    const panel = document.getElementById('search-results-panel');
    const summary = document.getElementById('search-results-summary');
    const table = document.getElementById('search-results-table');
    
    panel.classList.remove('hidden');
    document.getElementById('preview-filters').classList.remove('hidden');
    
    const sourceLabel = data.source === 'google_api' 
        ? '<span class="ml-2 px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Google API (FREE)</span>'
        : '<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Mock Data</span>';
    
    summary.innerHTML = `Found <strong>${data.total_found}</strong> restaurants in ${data.city}, ${data.country} ${sourceLabel}
        <br><span class="text-sm text-gray-500">Select restaurants, then click "Fetch Details" to get ratings & reviews</span>`;
    
    if (data.api_error) {
        summary.innerHTML += `<div class="mt-2 text-sm text-red-600 bg-red-50 p-2 rounded">
            API Error: ${data.api_error}
        </div>`;
    }
    
    // Show Fetch Details button, hide Import button
    document.getElementById('fetch-details-btn').classList.remove('hidden');
    document.getElementById('import-btn').classList.add('hidden');
    
    renderPreviewTable(data.results);
    updateSelectedCount();
    
    document.querySelectorAll('.result-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });
}

function renderPreviewTable(results) {
    const table = document.getElementById('search-results-table');
    let html = '';
    
    results.forEach((r, idx) => {
        const isDup = r.is_duplicate;
        const rowClass = isDup ? 'bg-amber-50' : '';
        const statusBadge = isDup 
            ? '<span class="px-2 py-1 bg-amber-200 text-amber-800 rounded text-xs">Exists</span>'
            : '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">New</span>';
        
        // In preview mode, we only have name and type
        const typeDisplay = r.primary_type ? r.primary_type.replace(/_/g, ' ') : (r.types?.[0] || 'restaurant');
        const ratingDisplay = r.rating ? `${r.rating}` : '<span class="text-gray-400">—</span>';
        const reviewsDisplay = r.review_count ? r.review_count : '<span class="text-gray-400">—</span>';
        const priceDisplay = r.price_level !== undefined ? ['Free', '$', '$$', '$$$', '$$$$'][r.price_level] : '<span class="text-gray-400">—</span>';
        
        html += `<tr class="${rowClass} border-b hover:bg-gray-50 preview-row" data-index="${idx}" data-name="${r.name.toLowerCase()}" data-type="${typeDisplay.toLowerCase()}">
            <td class="py-2"><input type="checkbox" class="result-checkbox" value="${idx}" ${!isDup ? 'checked' : ''}></td>
            <td class="py-2 font-medium">${r.name}</td>
            <td class="py-2 text-gray-500 text-xs capitalize">${typeDisplay}</td>
            <td class="py-2">${ratingDisplay}</td>
            <td class="py-2 text-gray-500">${reviewsDisplay}</td>
            <td class="py-2">${priceDisplay}</td>
            <td class="py-2 text-center text-gray-400">—</td>
            <td class="py-2 text-center text-gray-400">—</td>
            <td class="py-2">${statusBadge}</td>
        </tr>`;
    });
    
    table.innerHTML = html || '<tr><td colspan="9" class="py-4 text-center text-gray-400">No results</td></tr>';
}

function filterPreviewResults() {
    const nameFilter = document.getElementById('filter-name').value.toLowerCase();
    const typeFilter = document.getElementById('filter-type').value.toLowerCase();
    
    document.querySelectorAll('.preview-row').forEach(row => {
        const name = row.dataset.name;
        const type = row.dataset.type;
        
        const matchesName = !nameFilter || name.includes(nameFilter);
        const matchesType = !typeFilter || type.includes(typeFilter);
        
        row.style.display = (matchesName && matchesType) ? '' : 'none';
    });
}

// Step 2: Fetch Details for Selected (PAID - Essential fields)
async function fetchDetailsForSelected() {
    const selectedIdxs = Array.from(document.querySelectorAll('.result-checkbox:checked')).map(cb => parseInt(cb.value));
    
    if (selectedIdxs.length === 0) {
        showToast('Please select at least one restaurant', 'error');
        return;
    }
    
    const placeIds = selectedIdxs.map(idx => searchResults[idx].place_id).filter(Boolean);
    
    if (placeIds.length === 0) {
        showToast('No valid place IDs to fetch', 'error');
        return;
    }
    
    // Show progress
    document.getElementById('fetch-progress').classList.remove('hidden');
    document.getElementById('fetch-details-btn').disabled = true;
    
    try {
        const batchSize = 20;  // Process 20 at a time
        let completed = 0;
        
        for (let i = 0; i < placeIds.length; i += batchSize) {
            const batch = placeIds.slice(i, i + batchSize);
            
            document.getElementById('fetch-progress-text').textContent = `Fetching details... ${completed}/${placeIds.length}`;
            document.getElementById('fetch-progress-bar').style.width = `${(completed / placeIds.length) * 100}%`;
            
            const res = await fetch(`${API}/api/places/details`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ place_ids: batch })
            });
            const data = await res.json();
            
            if (data.success) {
                // Update searchResults with fetched details
                data.results.forEach(detail => {
                    const idx = searchResults.findIndex(r => r.place_id === detail.place_id);
                    if (idx !== -1) {
                        searchResults[idx] = { ...searchResults[idx], ...detail, has_details: true };
                    }
                });
            }
            
            completed += batch.length;
        }
        
        document.getElementById('fetch-progress-bar').style.width = '100%';
        document.getElementById('fetch-progress-text').textContent = 'Done!';
        
        // Re-render table with full details
        previewMode = false;
        displayFullResults();
        showToast(`Fetched details for ${placeIds.length} restaurants`);
        
        // Refresh cost analytics
        await loadCostAnalytics();
        
    } catch (err) {
        showToast('Error fetching details: ' + err.message, 'error');
    } finally {
        document.getElementById('fetch-details-btn').disabled = false;
        setTimeout(() => {
            document.getElementById('fetch-progress').classList.add('hidden');
        }, 1000);
    }
}

function displayFullResults() {
    // Show Import button, update Fetch Details button
    document.getElementById('import-btn').classList.remove('hidden');
    document.getElementById('fetch-details-btn').textContent = 'Re-fetch Details';
    
    const table = document.getElementById('search-results-table');
    const priceLabels = {0: 'Free', 1: '$', 2: '$$', 3: '$$$', 4: '$$$$'};
    
    // Count emails found
    const emailsFound = searchResults.filter(r => r.email).length;
    const summary = document.getElementById('search-results-summary');
    if (summary) {
        const totalWithDetails = searchResults.filter(r => r.has_details).length;
        summary.innerHTML = `<strong>${totalWithDetails}</strong> restaurants with details fetched. 
            <span class="ml-2 px-2 py-1 ${emailsFound > 0 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'} rounded text-xs">
                ${emailsFound} emails found
            </span>`;
    }
    
    let html = '';
    searchResults.forEach((r, idx) => {
        const isDup = r.is_duplicate;
        const rowClass = isDup ? 'bg-amber-50' : '';
        const hasDetails = r.has_details;
        
        let statusBadge;
        if (isDup) {
            statusBadge = '<span class="px-2 py-1 bg-amber-200 text-amber-800 rounded text-xs">Duplicate</span>';
        } else if (hasDetails) {
            statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Ready</span>';
        } else {
            statusBadge = '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">No details</span>';
        }
        
        const typeDisplay = r.primary_type ? r.primary_type.replace(/_/g, ' ') : 'restaurant';
        
        // Contact info display
        const emailDisplay = r.email 
            ? `<span class="text-green-600" title="${r.email}">Yes</span>` 
            : '<span class="text-gray-400">-</span>';
        const phoneDisplay = r.phone 
            ? `<span class="text-blue-600" title="${r.phone}">Yes</span>` 
            : '<span class="text-gray-400">-</span>';
        const websiteDisplay = r.website 
            ? `<a href="${r.website}" target="_blank" class="text-blue-500 hover:underline text-xs">Link</a>` 
            : '<span class="text-gray-400">-</span>';
        
        html += `<tr class="${rowClass} border-b hover:bg-gray-50" data-index="${idx}">
            <td class="py-2"><input type="checkbox" class="result-checkbox" value="${idx}" ${!isDup && hasDetails ? 'checked' : ''}></td>
            <td class="py-2 font-medium">${r.name}</td>
            <td class="py-2 text-gray-500 text-xs capitalize">${typeDisplay}</td>
            <td class="py-2">${r.rating || '-'}</td>
            <td class="py-2 text-gray-500">${r.review_count || '-'}</td>
            <td class="py-2">${priceLabels[r.price_level] || '-'}</td>
            <td class="py-2 text-center">${emailDisplay}</td>
            <td class="py-2 text-center">${phoneDisplay}</td>
            <td class="py-2">${statusBadge}</td>
        </tr>`;
    });
    
    table.innerHTML = html;
    updateSelectedCount();
    
    document.querySelectorAll('.result-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });
}

function updateSelectedCount() {
    const count = document.querySelectorAll('.result-checkbox:checked').length;
    document.getElementById('selected-count').textContent = count;
    document.getElementById('fetch-count').textContent = count;
    // Estimate cost: Place Details + Contact API costs ~$0.020 per request
    const cost = (count * 0.020).toFixed(2);
    document.getElementById('fetch-cost').textContent = cost;
}

function selectAllResults(checked) {
    document.querySelectorAll('.result-checkbox').forEach(cb => {
        if (cb.closest('tr').style.display !== 'none') {
            cb.checked = checked;
        }
    });
    document.getElementById('select-all-search').checked = checked;
    updateSelectedCount();
}

function clearSearchResults() {
    searchResults = [];
    previewMode = true;
    document.getElementById('search-results-panel').classList.add('hidden');
    document.getElementById('search-results-table').innerHTML = '';
    document.getElementById('fetch-details-btn').classList.add('hidden');
    document.getElementById('import-btn').classList.add('hidden');
    document.getElementById('preview-filters').classList.add('hidden');
}

async function importSelected() {
    const selectedIdxs = Array.from(document.querySelectorAll('.result-checkbox:checked')).map(cb => parseInt(cb.value));
    
    if (selectedIdxs.length === 0) {
        showToast('Please select at least one restaurant', 'error');
        return;
    }
    
    const selectedRestaurants = selectedIdxs.map(idx => searchResults[idx]).filter(r => r.has_details || r.rating);
    
    if (selectedRestaurants.length === 0) {
        showToast('Selected restaurants have no details. Click "Fetch Details" first.', 'error');
        return;
    }
    
    const skipDuplicates = document.getElementById('skip-duplicates').checked;
    
    document.getElementById('import-btn').disabled = true;
    document.getElementById('fetch-progress').classList.remove('hidden');
    document.getElementById('fetch-progress-text').textContent = 'Importing restaurants...';
    document.getElementById('fetch-progress-bar').style.width = '0%';
    
    try {
        // Batch import for large sets (50 at a time)
        const batchSize = 50;
        let totalImported = 0;
        let totalSkipped = 0;
        
        for (let i = 0; i < selectedRestaurants.length; i += batchSize) {
            const batch = selectedRestaurants.slice(i, i + batchSize);
            const progress = Math.round((i / selectedRestaurants.length) * 100);
            
            document.getElementById('fetch-progress-text').textContent = `Importing... ${i}/${selectedRestaurants.length}`;
            document.getElementById('fetch-progress-bar').style.width = `${progress}%`;
            
            const res = await fetch(`${API}/api/places/import`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    restaurants: batch,
                    city: currentCity,
                    country: currentCountry,
                    skip_duplicates: skipDuplicates
                })
            });
            const data = await res.json();
            
            if (data.success) {
                totalImported += data.imported || 0;
                totalSkipped += data.skipped || 0;
            } else {
                throw new Error(data.error || 'Import failed');
            }
        }
        
        document.getElementById('fetch-progress-bar').style.width = '100%';
        document.getElementById('fetch-progress-text').textContent = 'Done!';
        
        showToast(`Imported ${totalImported} restaurants, skipped ${totalSkipped}`);
        
        // Refresh all displays after import
        setTimeout(async () => {
            clearSearchResults();
            await loadDashboard();
            await loadCities();
            await loadCostAnalytics();
            refreshMapIfVisible();
        }, 500);
        
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    } finally {
        document.getElementById('import-btn').innerHTML = 'Import Selected (<span id="selected-count">0</span>)';
        document.getElementById('import-btn').disabled = false;
        setTimeout(() => {
            document.getElementById('fetch-progress').classList.add('hidden');
        }, 1500);
    }
}

async function checkDuplicates() {
    try {
        const res = await fetch(`${API}/api/restaurants/check-duplicates`);
        const data = await res.json();
        
        const container = document.getElementById('duplicates-list');
        container.classList.remove('hidden');
        
        if (data.total_duplicate_groups === 0) {
            container.innerHTML = '<p class="text-green-600 text-sm"> No duplicates found!</p>';
        } else {
            let html = `<p class="text-amber-600 text-sm mb-3"> Found ${data.total_duplicate_groups} duplicate groups:</p>`;
            html += '<div class="space-y-2">';
            
            data.duplicates.forEach(d => {
                const ids = typeof d.ids === 'string' ? d.ids : (d.ids || []).join(', ');
                html += `<div class="p-2 bg-amber-50 rounded text-sm">
                    <strong>${d.name}</strong> in ${d.city} (${d.country || 'Unknown'})
                    <br><span class="text-gray-500 text-xs">IDs: ${ids} | Count: ${d.count}</span>
                </div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
    } catch (err) {
        showToast('Error checking duplicates: ' + err.message, 'error');
    }
}

async function loadJobs() {
    const res = await fetch(`${API}/api/scrape/jobs`);
    const jobs = await res.json();
    const html = jobs.map(j => `
        <tr class="border-b">
            <td class="py-2">#${j.id}</td>
            <td>${j.region_code || j.location || '-'}</td>
            <td class="text-xs">${j.min_rating ? '≥'+j.min_rating+'★' : ''} ${j.max_price_level ? '≤'+j.max_price_level : ''}</td>
            <td><span class="text-xs px-2 py-1 rounded-full ${j.status==='completed'?'bg-green-100 text-green-700':j.status==='failed'?'bg-red-100 text-red-700':'bg-gray-100'}">${j.status}</span></td>
            <td>${j.restaurants_found || 0} / ${j.reviews_found || 0}</td>
            <td class="text-gray-500">${j.created_at?.split('T')[0] || '-'}</td>
        </tr>
    `).join('');
    document.getElementById('job-history').innerHTML = html || '<tr><td colspan="6" class="py-4 text-center text-gray-400">No jobs</td></tr>';
}

// ========== MODEL WEIGHTS ==========

async function loadWeights() {
    const res = await fetch(`${API}/api/ranking/weights`);
    const w = await res.json();
    
    ['google','yelp','tripadvisor','user_reviews','sentiment','text_sentiment','data_quality'].forEach(k => {
        const el = document.getElementById(`w-${k}`);
        if (el) {
            el.value = w[`weight_${k}`] || 0;
            updateWeight(k);
        }
    });
    document.getElementById('w-min-reviews').value = w.min_reviews_threshold || 5;
    
    // Load sentiment stats
    loadSentimentStats();
}

function updateWeight(k) {
    const el = document.getElementById(`w-${k}`);
    const valEl = document.getElementById(`w-${k}-val`);
    if (el && valEl) valEl.textContent = parseFloat(el.value).toFixed(2);
}

async function saveWeights(e) {
    e.preventDefault();
    await fetch(`${API}/api/ranking/weights`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            weight_google: parseFloat(document.getElementById('w-google').value),
            weight_yelp: parseFloat(document.getElementById('w-yelp').value),
            weight_tripadvisor: parseFloat(document.getElementById('w-tripadvisor').value),
            weight_user_reviews: parseFloat(document.getElementById('w-user_reviews').value),
            weight_sentiment: parseFloat(document.getElementById('w-sentiment').value),
            weight_text_sentiment: parseFloat(document.getElementById('w-text_sentiment').value),
            weight_data_quality: parseFloat(document.getElementById('w-data_quality').value),
            min_reviews_threshold: parseInt(document.getElementById('w-min-reviews').value)
        })
    });
    showToast('Weights saved');
}

async function loadSentimentStats() {
    try {
        const res = await fetch(`${API}/api/sentiment/stats`);
        const stats = await res.json();
        
        document.getElementById('stat-total-reviews').textContent = stats.total_reviews || 0;
        document.getElementById('stat-with-text').textContent = stats.with_text || 0;
        document.getElementById('stat-avg-sentiment').textContent = stats.avg_sentiment?.toFixed(3) || '0.000';
        document.getElementById('stat-positive').textContent = stats.positive || 0;
        document.getElementById('stat-neutral').textContent = stats.neutral || 0;
        document.getElementById('stat-negative').textContent = stats.negative || 0;
        
        // Aspect stats
        const aspects = stats.aspects || {};
        for (const aspect of ['food', 'service', 'ambiance', 'value']) {
            const el = document.getElementById(`stat-aspect-${aspect}`);
            if (el && aspects[aspect]) {
                const score = aspects[aspect].avg || 0;
                const color = score > 0 ? 'text-green-600' : (score < 0 ? 'text-red-600' : 'text-gray-600');
                el.innerHTML = `<span class="${color}">${score.toFixed(2)}</span> <span class="text-gray-400">(${aspects[aspect].count})</span>`;
            }
        }
    } catch (e) {
        console.error('Failed to load sentiment stats:', e);
    }
}

async function reanalyzeReviews() {
    const btn = document.getElementById('reanalyze-btn');
    const progress = document.getElementById('reanalyze-progress');
    const status = document.getElementById('reanalyze-status');
    
    btn.disabled = true;
    progress.classList.remove('hidden');
    status.textContent = 'Analyzing reviews with NLP...';
    
    try {
        const res = await fetch(`${API}/api/sentiment/reanalyze`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ limit: 500 })
        });
        const data = await res.json();
        
        if (data.success) {
            status.textContent = `Done! Updated ${data.updated} reviews. Text weight used: ${(data.text_weight_used * 100).toFixed(0)}%`;
            status.className = 'text-sm text-green-700';
            loadSentimentStats();
        } else {
            status.textContent = 'Error: ' + (data.error || 'Unknown error');
            status.className = 'text-sm text-red-700';
        }
    } catch (e) {
        status.textContent = 'Error: ' + e.message;
        status.className = 'text-sm text-red-700';
    }
    
    btn.disabled = false;
    setTimeout(() => progress.classList.add('hidden'), 5000);
}

function testSentiment() {
    const text = prompt('Enter review text to analyze:');
    if (!text) return;
    
    const rating = prompt('Star rating (1-5, optional):', '');
    
    fetch(`${API}/api/sentiment/analyze`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text, rating: rating ? parseInt(rating) : null })
    })
    .then(r => r.json())
    .then(data => {
        let msg = `Sentiment Analysis Results:\n\n`;
        msg += `Polarity: ${data.polarity?.toFixed(3) || 'N/A'} (${data.label || 'unknown'})\n`;
        msg += `Subjectivity: ${data.subjectivity?.toFixed(3) || 'N/A'}\n`;
        msg += `Confidence: ${data.confidence?.toFixed(3) || 'N/A'}\n`;
        
        if (data.combined_score !== undefined) {
            msg += `\nCombined Score: ${data.combined_score.toFixed(3)}\n`;
            msg += `(Text weight: ${(data.text_weight_used * 100).toFixed(0)}%)\n`;
        }
        
        if (data.aspects && Object.keys(data.aspects).length > 0) {
            msg += `\nAspect Scores:\n`;
            for (const [aspect, score] of Object.entries(data.aspects)) {
                msg += `  ${aspect}: ${score.toFixed(2)}\n`;
            }
        }
        
        alert(msg);
    })
    .catch(e => alert('Error: ' + e.message));
}

// ========== SENTIMENT KEYWORDS ==========

let keywordsData = { custom_keywords: [], default_keywords: {} };
let currentKeywordFilter = '';

function toggleKeywordPanel() {
    const panel = document.getElementById('keyword-panel');
    const toggle = document.getElementById('keyword-panel-toggle');
    
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.textContent = 'Hide Keywords';
        loadKeywords();
    } else {
        panel.classList.add('hidden');
        toggle.textContent = 'Show Keywords';
    }
}

async function loadKeywords() {
    try {
        const res = await fetch(`${API}/api/sentiment/keywords`);
        keywordsData = await res.json();
        renderKeywords();
        renderDefaultKeywords();
    } catch (e) {
        console.error('Failed to load keywords:', e);
    }
}

function renderKeywords() {
    const container = document.getElementById('keywords-list');
    const keywords = keywordsData.custom_keywords || [];
    
    // Filter by category if set
    const filtered = currentKeywordFilter 
        ? keywords.filter(k => k.category === currentKeywordFilter)
        : keywords;
    
    if (filtered.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm col-span-2">No custom keywords added yet.</p>';
        return;
    }
    
    // Group by category
    const grouped = {};
    filtered.forEach(k => {
        if (!grouped[k.category]) grouped[k.category] = { positive: [], negative: [] };
        grouped[k.category][k.sentiment].push(k);
    });
    
    let html = '';
    for (const [category, sentiments] of Object.entries(grouped)) {
        html += `<div class="bg-white border rounded-lg p-3">
            <h6 class="font-medium text-sm mb-2 capitalize">${category}</h6>
            <div class="space-y-2">`;
        
        if (sentiments.positive.length > 0) {
            html += `<div>
                <span class="text-xs text-green-600 font-medium">Positive:</span>
                <div class="flex flex-wrap gap-1 mt-1">`;
            sentiments.positive.forEach(k => {
                html += `<span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded text-xs">
                    ${k.keyword}
                    <button onclick="deleteKeyword(${k.id})" class="text-green-500 hover:text-red-500">&times;</button>
                </span>`;
            });
            html += `</div></div>`;
        }
        
        if (sentiments.negative.length > 0) {
            html += `<div>
                <span class="text-xs text-red-600 font-medium">Negative:</span>
                <div class="flex flex-wrap gap-1 mt-1">`;
            sentiments.negative.forEach(k => {
                html += `<span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded text-xs">
                    ${k.keyword}
                    <button onclick="deleteKeyword(${k.id})" class="text-red-500 hover:text-red-700">&times;</button>
                </span>`;
            });
            html += `</div></div>`;
        }
        
        html += `</div></div>`;
    }
    
    container.innerHTML = html;
}

function renderDefaultKeywords() {
    const container = document.getElementById('default-keywords-list');
    const defaults = keywordsData.default_keywords || {};
    
    let html = '<div class="grid grid-cols-2 md:grid-cols-4 gap-2">';
    for (const [category, sentiments] of Object.entries(defaults)) {
        html += `<div>
            <span class="font-medium capitalize">${category}:</span>
            <div class="text-green-600">+ ${sentiments.positive?.slice(0, 5).join(', ')}...</div>
            <div class="text-red-600">- ${sentiments.negative?.slice(0, 5).join(', ')}...</div>
        </div>`;
    }
    html += '</div>';
    container.innerHTML = html;
}

function filterKeywordsByCategory(category) {
    currentKeywordFilter = category;
    
    // Update button styles
    document.querySelectorAll('.keyword-cat-btn').forEach(btn => {
        if (btn.dataset.cat === category) {
            btn.classList.add('bg-spot-burgundy', 'text-white');
            btn.classList.remove('border', 'hover:bg-gray-50');
        } else {
            btn.classList.remove('bg-spot-burgundy', 'text-white');
            btn.classList.add('border', 'hover:bg-gray-50');
        }
    });
    
    renderKeywords();
}

async function addKeyword() {
    const keyword = document.getElementById('new-keyword').value.trim();
    const category = document.getElementById('new-keyword-category').value;
    const sentiment = document.getElementById('new-keyword-sentiment').value;
    
    if (!keyword) {
        showToast('Please enter a keyword', 'error');
        return;
    }
    
    try {
        const res = await fetch(`${API}/api/sentiment/keywords`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ keyword, category, sentiment })
        });
        const data = await res.json();
        
        if (data.success) {
            showToast(`Added "${keyword}" to ${category} (${sentiment})`);
            document.getElementById('new-keyword').value = '';
            loadKeywords();
        } else {
            showToast(data.error || 'Failed to add keyword', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function addBulkKeywords() {
    const text = document.getElementById('bulk-keywords').value.trim();
    const category = document.getElementById('bulk-category').value;
    const sentiment = document.getElementById('bulk-sentiment').value;
    
    if (!text) {
        showToast('Please enter keywords', 'error');
        return;
    }
    
    const keywords = text.split('\n')
        .map(k => k.trim())
        .filter(k => k.length > 0)
        .map(k => ({ keyword: k, category, sentiment }));
    
    if (keywords.length === 0) {
        showToast('No valid keywords found', 'error');
        return;
    }
    
    try {
        const res = await fetch(`${API}/api/sentiment/keywords/bulk`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ keywords })
        });
        const data = await res.json();
        
        if (data.success) {
            showToast(`Added ${data.added} keywords to ${category}`);
            document.getElementById('bulk-keywords').value = '';
            loadKeywords();
        } else {
            showToast(data.error || 'Failed to add keywords', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function deleteKeyword(id) {
    if (!confirm('Delete this keyword?')) return;
    
    try {
        const res = await fetch(`${API}/api/sentiment/keywords/${id}`, {
            method: 'DELETE'
        });
        const data = await res.json();
        
        if (data.success) {
            showToast('Keyword deleted');
            loadKeywords();
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function recomputeAll() {
    showToast('Recomputing all rankings...');
    await fetch(`${API}/api/rankings/compute`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'});
    showToast('All rankings recomputed');
}

// ========== RESTAURANTS ==========

async function loadRestaurants() {
    const region = document.getElementById('rest-city-filter')?.value || '';
    const url = region ? `${API}/api/restaurants?region=${region}` : `${API}/api/restaurants`;
    const res = await fetch(url);
    restaurantsData = await res.json();
    renderRestaurants(restaurantsData);
}

function renderRestaurants(data) {
    const html = data.map(r => `
        <tr class="border-b hover:bg-gray-50">
            <td class="py-2">${r.manual_rank || r.auto_rank || '-'}</td>
            <td class="font-medium">${r.name}</td>
            <td class="text-gray-500">${r.region_code || r.city || '-'}</td>
            <td>${r.cuisine_type || '-'}</td>
            <td class="text-sm">
                ${r.email ? `<span class="text-green-600" title="${r.email}">Yes</span>` : 
                  (r.website ? '<span class="text-amber-500" title="Has website, email can be extracted">Pending</span>' : '<span class="text-gray-400">-</span>')}
            </td>
            <td class="text-sm">
                ${r.phone ? `<span class="text-blue-600" title="${r.phone}">Yes</span>` : '<span class="text-gray-400">-</span>'}
            </td>
            <td class="font-bold text-spot-burgundy">${r.composite_score?.toFixed(2) || '-'}</td>
            <td>
                ${r.is_published ? '<span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">Pub</span>' : ''}
                ${r.is_pushed ? '<span class="text-xs px-2 py-1 bg-spot-burgundy/20 text-spot-burgundy rounded-full ml-1">Push</span>' : ''}
            </td>
        </tr>
    `).join('');
    document.getElementById('restaurant-table').innerHTML = html || '<tr><td colspan="8" class="py-4 text-center text-gray-400">No restaurants</td></tr>';
}

async function extractMissingEmails() {
    const progressDiv = document.getElementById('email-extract-progress');
    const progressText = document.getElementById('email-extract-text');
    const progressCount = document.getElementById('email-extract-count');
    const progressBar = document.getElementById('email-extract-bar');
    
    progressDiv.classList.remove('hidden');
    progressText.textContent = 'Starting email extraction...';
    progressBar.style.width = '0%';
    
    try {
        // First, get count of restaurants needing emails
        const countRes = await fetch(`${API}/api/restaurants?needs_email=1`);
        const needsEmail = await countRes.json();
        const total = needsEmail.length || 0;
        
        if (total === 0) {
            progressText.textContent = 'No restaurants need email extraction';
            setTimeout(() => progressDiv.classList.add('hidden'), 2000);
            return;
        }
        
        progressCount.textContent = `0/${total}`;
        
        // Process in batches of 10
        const batchSize = 10;
        let processed = 0;
        let found = 0;
        
        for (let i = 0; i < total; i += batchSize) {
            const batch = needsEmail.slice(i, i + batchSize);
            const batchIds = batch.map(r => r.id);
            
            progressText.textContent = `Extracting emails from websites...`;
            progressCount.textContent = `${processed}/${total}`;
            progressBar.style.width = `${(processed / total) * 100}%`;
            
            const res = await fetch(`${API}/api/restaurants/extract-emails`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ restaurant_ids: batchIds })
            });
            const data = await res.json();
            
            if (data.success) {
                found += data.emails_found || 0;
            }
            
            processed += batch.length;
        }
        
        progressBar.style.width = '100%';
        progressText.textContent = `Done! Found ${found} emails out of ${total} restaurants`;
        progressCount.textContent = `${found}/${total}`;
        
        // Reload restaurants to show updated emails
        await loadRestaurants();
        
        setTimeout(() => progressDiv.classList.add('hidden'), 3000);
        
    } catch (err) {
        progressText.textContent = 'Error: ' + err.message;
        setTimeout(() => progressDiv.classList.add('hidden'), 3000);
    }
}

function filterRestaurants() {
    const q = document.getElementById('restaurant-search').value.toLowerCase();
    const filtered = restaurantsData.filter(r => r.name.toLowerCase().includes(q));
    renderRestaurants(filtered);
}

// ========== RANKINGS ==========

let currentPublishMode = 'top'; // 'top' or 'selected'

async function loadRankings() {
    const city = document.getElementById('rank-city').value;
    
    // Load all rankings by default, or filter by city if selected
    const url = city ? `${API}/api/rankings?region=${city}` : `${API}/api/rankings`;
    const res = await fetch(url);
    const rankings = await res.json();
    
    const html = rankings.map(r => `
        <tr class="border-b hover:bg-gray-50">
            <td class="py-2"><input type="checkbox" class="rank-select" value="${r.id}" data-city="${r.region_code || r.city}" onchange="updateSelectionCount()"></td>
            <td>${r.auto_rank || '-'}</td>
            <td><input type="number" value="${r.manual_rank || ''}" class="w-16 border rounded px-2 py-1 text-sm" onchange="updateRank(${r.id}, this.value)" placeholder="-"></td>
            <td>
                <div class="font-medium">${r.name}</div>
                <div class="text-xs text-gray-400">${r.cuisine_type || ''} - ${r.city || ''}</div>
            </td>
            <td class="font-bold text-spot-burgundy">${r.composite_score?.toFixed(2) || '-'}</td>
            <td>${r.total_reviews || 0}</td>
            <td>
                ${r.is_published ? '<span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">Published</span>' :
                  '<span class="text-xs px-2 py-1 bg-gray-100 text-gray-500 rounded-full">Draft</span>'}
            </td>
        </tr>
    `).join('');
    document.getElementById('rankings-table').innerHTML = html || '<tr><td colspan="7" class="py-4 text-center text-gray-400">No rankings yet. Click "Compute All Rankings" in Data Collection.</td></tr>';
    updateSelectionCount();
}

async function updateRank(id, val) {
    await fetch(`${API}/api/rankings/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ manual_rank: val ? parseInt(val) : null })
    });
}

async function recomputeCity() {
    const city = document.getElementById('rank-city').value;
    
    showToast('Recomputing rankings...');
    await fetch(`${API}/api/rankings/compute`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ region: city || null })
    });
    loadRankings();
    showToast('Rankings recomputed');
}

function toggleSelectAll() {
    const checked = document.getElementById('selectAll').checked;
    document.querySelectorAll('.rank-select').forEach(cb => cb.checked = checked);
    updateSelectionCount();
}

function updateSelectionCount() {
    const count = document.querySelectorAll('.rank-select:checked').length;
    document.getElementById('selection-count').textContent = count;
}

function getSelectedIds() {
    return [...document.querySelectorAll('.rank-select:checked')].map(cb => parseInt(cb.value));
}

// Modal Functions
function openPublishModal(mode = 'top') {
    const region = document.getElementById('rank-city').value;
    if (!region) return showToast('Select a city first', 'error');
    
    currentPublishMode = mode;
    document.getElementById('modal-region-info').textContent = `City: ${region}`;
    
    if (mode === 'selected') {
        const count = getSelectedIds().length;
        if (count === 0) return showToast('Select at least one restaurant', 'error');
        document.getElementById('modal-publish-count').value = 'selected';
        document.getElementById('modal-publish-count').disabled = true;
    } else {
        document.getElementById('modal-publish-count').disabled = false;
    }
    
    document.getElementById('publish-modal').classList.remove('hidden');
}

function closePublishModal() {
    document.getElementById('publish-modal').classList.add('hidden');
    document.getElementById('modal-publish-count').disabled = false;
}

function openConfirmPushModal() {
    const region = document.getElementById('rank-city').value;
    const countSelect = document.getElementById('modal-publish-count').value;
    let count;
    
    if (countSelect === 'selected') {
        count = getSelectedIds().length;
    } else {
        count = parseInt(countSelect);
    }
    
    document.getElementById('confirm-region').textContent = region;
    document.getElementById('confirm-count').textContent = count + ' restaurants';
    
    document.getElementById('publish-modal').classList.add('hidden');
    document.getElementById('confirm-push-modal').classList.remove('hidden');
}

function closeConfirmPushModal() {
    document.getElementById('confirm-push-modal').classList.add('hidden');
}

async function preApproveOnly() {
    const region = document.getElementById('rank-city').value;
    const countSelect = document.getElementById('modal-publish-count').value;
    
    let body = { region };
    
    if (countSelect === 'selected') {
        body.restaurant_ids = getSelectedIds();
    } else {
        body.top_n = parseInt(countSelect);
    }
    
    await fetch(`${API}/api/rankings/publish`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
    });
    
    closePublishModal();
    loadRankings();
    showToast('Rankings pre-approved. Push to website when ready.');
}

async function executePush() {
    const region = document.getElementById('rank-city').value;
    const countSelect = document.getElementById('modal-publish-count').value;
    
    // First pre-approve
    let publishBody = { region };
    if (countSelect === 'selected') {
        publishBody.restaurant_ids = getSelectedIds();
    } else {
        publishBody.top_n = parseInt(countSelect);
    }
    
    await fetch(`${API}/api/rankings/publish`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(publishBody)
    });
    
    // Then push
    let pushBody = { region };
    if (countSelect === 'selected') {
        pushBody.restaurant_ids = getSelectedIds();
    } else {
        pushBody.top_n = parseInt(countSelect);
    }
    
    const res = await fetch(`${API}/api/website/push`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(pushBody)
    });
    
    const data = await res.json();
    
    closeConfirmPushModal();
    loadRankings();
    
    if (data.success) {
        const emailMsg = data.welcome_emails_sent > 0 ? ` (${data.welcome_emails_sent} welcome emails sent)` : '';
        showToast(`Pushed ${data.pushed} restaurants to website${emailMsg}`);
    } else {
        showToast('Push failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

// Backup / Export
function toggleBackupMenu() {
    const menu = document.getElementById('backup-menu');
    menu.classList.toggle('hidden');
    
    // Close menu when clicking outside
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            if (!e.target.closest('#backup-menu') && !e.target.closest('[onclick="toggleBackupMenu()"]')) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 10);
}

async function downloadBackup(format = 'json') {
    const region = document.getElementById('rank-city').value;
    document.getElementById('backup-menu').classList.add('hidden');
    
    showToast('Preparing backup...');
    
    const url = region ? `${API}/api/backup?region=${region}` : `${API}/api/backup`;
    const res = await fetch(url);
    const data = await res.json();
    
    const date = new Date().toISOString().split('T')[0];
    const filename = region ? `rankings-backup-${region}-${date}` : `rankings-backup-all-${date}`;
    
    if (format === 'csv') {
        // Convert to CSV
        const restaurants = data.restaurants || [];
        if (restaurants.length === 0) {
            showToast('No data to export', 'error');
            return;
        }
        
        const headers = ['id', 'name', 'address', 'city', 'region_code', 'cuisine_type', 'price_range', 
                        'email', 'phone', 'composite_score', 'auto_rank', 'manual_rank', 
                        'is_published', 'is_pushed', 'total_reviews'];
        
        let csv = headers.join(',') + '\n';
        restaurants.forEach(r => {
            const row = headers.map(h => {
                let val = r[h] ?? '';
                if (typeof val === 'string' && (val.includes(',') || val.includes('"'))) {
                    val = '"' + val.replace(/"/g, '""') + '"';
                }
                return val;
            });
            csv += row.join(',') + '\n';
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);
    } else {
        // JSON format
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);
    }
    
    showToast('Backup downloaded');
}

function openRestoreModal() {
    document.getElementById('backup-menu').classList.add('hidden');
    document.getElementById('restore-modal').classList.remove('hidden');
}

function closeRestoreModal() {
    document.getElementById('restore-modal').classList.add('hidden');
    document.getElementById('restore-file').value = '';
}

async function executeRestore() {
    const fileInput = document.getElementById('restore-file');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Please select a file', 'error');
        return;
    }
    
    try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        const res = await fetch(`${API}/api/backup/restore`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
            closeRestoreModal();
            loadRankings();
            showToast(`Restored ${result.restored} rankings`);
        } else {
            showToast('Restore failed: ' + result.error, 'error');
        }
    } catch (e) {
        showToast('Invalid backup file: ' + e.message, 'error');
    }
}

// ========== SCHEMA ANALYZER & FIELD MAPPING ==========

let detectedSchema = null;
let detectedMapping = {};
let rawResponseData = null;

// Known field mappings (your website field -> spotwego field)
const fieldMappingHints = {
    // Name variations
    'name': 'name', 'title': 'name', 'restaurant_name': 'name', 'restaurantName': 'name', 'nom': 'name', 'label': 'name',
    // Address
    'address': 'address', 'street': 'address', 'adresse': 'address', 'addr': 'address', 'full_address': 'address',
    // City
    'city': 'city', 'ville': 'city', 'town': 'city', 'locality': 'city', 'area': 'city',
    // Region/Canton
    'region': 'canton', 'canton': 'canton', 'state': 'canton', 'province': 'canton',
    // Country
    'country': 'country', 'pays': 'country', 'nation': 'country',
    // Coordinates
    'latitude': 'latitude', 'lat': 'latitude', 'geo_lat': 'latitude', 'y': 'latitude',
    'longitude': 'longitude', 'lng': 'longitude', 'lon': 'longitude', 'geo_lng': 'longitude', 'x': 'longitude',
    // Cuisine
    'cuisine': 'cuisine_type', 'cuisine_type': 'cuisine_type', 'cuisineType': 'cuisine_type', 'type': 'cuisine_type', 
    'category': 'cuisine_type', 'food_type': 'cuisine_type',
    // Price
    'price': 'price_range', 'price_range': 'price_range', 'priceRange': 'price_range', 'price_level': 'price_range', 'cost': 'price_range',
    // Rating
    'rating': 'google_rating', 'google_rating': 'google_rating', 'googleRating': 'google_rating', 'score': 'google_rating', 'stars': 'google_rating', 'note': 'google_rating',
    // Reviews
    'reviews': 'google_reviews', 'review_count': 'google_reviews', 'reviewCount': 'google_reviews', 'num_reviews': 'google_reviews', 'reviews_count': 'google_reviews',
    // Contact
    'phone': 'phone', 'telephone': 'phone', 'tel': 'phone', 'phone_number': 'phone', 'contact': 'phone',
    'website': 'website', 'url': 'website', 'web': 'website', 'site': 'website', 'homepage': 'website',
    // Image
    'image': 'image_url', 'image_url': 'image_url', 'imageUrl': 'image_url', 'photo': 'image_url', 'thumbnail': 'image_url', 'picture': 'image_url', 'img': 'image_url',
    // IDs
    'id': 'id', 'place_id': 'google_place_id', 'google_place_id': 'google_place_id'
};

async function analyzeWebsiteUrl() {
    const url = document.getElementById('analyze-url').value.trim();
    if (!url) {
        showToast('Enter a URL to analyze', 'error');
        return;
    }
    
    document.getElementById('analyze-btn').textContent = 'Analyzing...';
    document.getElementById('analyze-btn').disabled = true;
    
    try {
        const res = await fetch(`${API}/api/schema/analyze-url`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url })
        });
        const data = await res.json();
        
        if (data.success) {
            rawResponseData = data.raw_data;
            displayAnalysisResults(data);
            showToast(`Analyzed successfully - ${data.fields_count} fields detected`);
        } else {
            showToast('Analysis failed: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    } finally {
        document.getElementById('analyze-btn').textContent = 'Analyze';
        document.getElementById('analyze-btn').disabled = false;
    }
}

function displayAnalysisResults(data) {
    document.getElementById('schema-results').classList.remove('hidden');
    document.getElementById('detected-type').textContent = data.data_type || 'Unknown';
    document.getElementById('detected-count').textContent = data.records_count || '0';
    document.getElementById('field-count').textContent = data.fields_count || '0';
    
    // Display detected fields as tags
    const fieldsHtml = (data.fields || []).map(f => 
        `<span class="px-2 py-1 bg-gray-100 rounded text-xs">${f}</span>`
    ).join('');
    document.getElementById('detected-fields').innerHTML = fieldsHtml || '<span class="text-gray-400">No fields detected</span>';
    
    // Build mapping table
    detectedMapping = {};
    let mappingHtml = '';
    
    (data.fields || []).forEach(field => {
        const fieldLower = field.toLowerCase();
        const spotwegoField = fieldMappingHints[fieldLower] || fieldMappingHints[field] || null;
        const sample = data.sample_values?.[field] || '-';
        
        if (spotwegoField) {
            detectedMapping[field] = spotwegoField;
        }
        
        mappingHtml += `<tr class="border-b">
            <td class="py-2 font-medium">${field}</td>
            <td class="py-2 ${spotwegoField ? 'text-green-600' : 'text-gray-400'}">${spotwegoField || '(not mapped)'}</td>
            <td class="py-2 text-gray-500 text-xs truncate max-w-xs">${String(sample).substring(0, 50)}</td>
        </tr>`;
    });
    
    document.getElementById('mapping-table').innerHTML = mappingHtml || '<tr><td colspan="3" class="py-4 text-center text-gray-400">No fields to map</td></tr>';
    
    // Store raw data for viewing
    document.getElementById('raw-data').textContent = JSON.stringify(data.raw_data, null, 2);
}

function toggleRawData() {
    document.getElementById('raw-data-panel').classList.toggle('hidden');
}

async function applyDetectedMapping() {
    if (Object.keys(detectedMapping).length === 0) {
        showToast('No mapping detected', 'error');
        return;
    }
    
    // Convert to Spotwego format (spotwego_field -> website_field)
    const mapping = {};
    Object.entries(detectedMapping).forEach(([websiteField, spotwegoField]) => {
        mapping[spotwegoField] = { target: websiteField, include: true, transform: 'none' };
    });
    
    try {
        await fetch(`${API}/api/schema/mapping`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ mapping })
        });
        
        localStorage.setItem('spotwego_field_mapping', JSON.stringify(mapping));
        displayCurrentMapping(mapping);
        showToast('Mapping applied and saved');
    } catch (err) {
        showToast('Error saving mapping: ' + err.message, 'error');
    }
}

function displayCurrentMapping(mapping) {
    if (!mapping || Object.keys(mapping).length === 0) {
        document.getElementById('current-mapping-display').innerHTML = 
            '<span class="text-gray-400">No mapping configured. Analyze a URL above to auto-detect.</span>';
        return;
    }
    
    let html = '<div class="grid grid-cols-2 md:grid-cols-3 gap-2">';
    Object.entries(mapping).forEach(([spotwegoField, config]) => {
        if (config.include) {
            html += `<div class="bg-gray-50 rounded px-2 py-1 text-xs">
                <span class="text-gray-500">${spotwegoField}</span> → <span class="font-medium">${config.target}</span>
            </div>`;
        }
    });
    html += '</div>';
    
    document.getElementById('current-mapping-display').innerHTML = html;
}

function clearFieldMapping() {
    if (!confirm('Clear all field mappings?')) return;
    
    localStorage.removeItem('spotwego_field_mapping');
    fetch(`${API}/api/schema/mapping`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ mapping: {} })
    });
    
    displayCurrentMapping({});
    showToast('Mapping cleared');
}

// ========== WEBSITE CONFIG ==========

async function loadWebsiteConfig() {
    await loadCities();
    const res = await fetch(`${API}/api/website/config`);
    const cfg = await res.json();
    document.getElementById('ws-url').value = cfg.api_url || '';
    document.getElementById('ws-endpoint').value = cfg.push_endpoint || '/api/restaurants/import';
    
    // Load saved mapping from server
    try {
        const mapRes = await fetch(`${API}/api/schema/mapping`);
        const mapData = await mapRes.json();
        if (mapData.success && mapData.mapping) {
            displayCurrentMapping(mapData.mapping);
        }
    } catch (e) {
        console.log('No saved mapping');
    }
}

async function saveWebsiteConfig(e) {
    e.preventDefault();
    await fetch(`${API}/api/website/config`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            api_url: document.getElementById('ws-url').value,
            push_endpoint: document.getElementById('ws-endpoint').value,
            api_key: document.getElementById('ws-key').value
        })
    });
    showToast('Configuration saved');
}

async function pushRegionFromWebsite() {
    const region = document.getElementById('push-city').value;
    const topN = parseInt(document.getElementById('push-count').value);
    if (!region) return showToast('Select a city', 'error');
    
    const res = await fetch(`${API}/api/website/push`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ region, top_n: topN })
    });
    const data = await res.json();
    if (data.success) {
        showToast(`Pushed ${data.pushed} restaurants for ${region}`);
        loadPushHistory();
    } else {
        showToast('Push failed: ' + (data.error || ''), 'error');
    }
}

async function loadPushHistory() {
    const res = await fetch(`${API}/api/website/push/history`);
    const history = await res.json();
    const html = history.map(h => `
        <div class="flex justify-between py-2 border-b last:border-0">
            <span><strong>${h.region_code || 'All'}</strong> - ${h.restaurants_pushed} restaurants - ${h.pushed_at?.split('T')[0] || '-'}</span>
            <span class="text-xs px-2 py-1 rounded-full ${h.status === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${h.status}</span>
        </div>
    `).join('');
    document.getElementById('push-history').innerHTML = html || '<div class="text-gray-400">No history</div>';
}

// ========== AUTOMATION ==========

async function loadAutomationSettings() {
    await loadCities();
    const html = citiesData.map(r => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div>
                <div class="font-medium">${r.name}</div>
                <div class="text-sm text-gray-500">${r.restaurants_count || 0} restaurants</div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-sm">
                    <label>Top N:</label>
                    <select class="border rounded px-2 py-1 ml-1" onchange="updateRegionPush('${r.code}', this.value)">
                        <option value="10" ${r.push_top_n == 10 ? 'selected' : ''}>10</option>
                        <option value="20" ${r.push_top_n == 20 || !r.push_top_n ? 'selected' : ''}>20</option>
                        <option value="30" ${r.push_top_n == 30 ? 'selected' : ''}>30</option>
                        <option value="50" ${r.push_top_n == 50 ? 'selected' : ''}>50</option>
                    </select>
                </div>
                <label class="toggle">
                    <input type="checkbox" ${r.auto_push ? 'checked' : ''} onchange="toggleAutoPush('${r.code}', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
                <span class="text-sm w-20">${r.auto_push ? 'Auto Push' : 'Manual'}</span>
            </div>
        </div>
    `).join('');
    document.getElementById('city-auto-settings').innerHTML = html || '<p class="text-gray-400">No cities</p>';
}

async function toggleAutoPush(code, enabled) {
    await fetch(`${API}/api/regions/${code}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ auto_push: enabled ? 1 : 0 })
    });
}

async function updateRegionPush(code, topN) {
    await fetch(`${API}/api/regions/${code}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ push_top_n: parseInt(topN) })
    });
}

async function runDailyTasks() {
    showToast('Running daily tasks...');
    const res = await fetch(`${API}/api/daily/run`, {method: 'POST'});
    const data = await res.json();
    showToast(`Recomputed ${data.regions_computed?.length || 0} regions`);
    loadDashboard();
}

// ========== EMAIL MANAGEMENT ==========

// ========== DEMO DATA ==========

async function loadDemoData() {
    const btn = document.getElementById('demo-load-btn');
    const status = document.getElementById('demo-status');
    
    btn.textContent = 'Loading...';
    btn.disabled = true;
    status.classList.add('hidden');
    
    try {
        const res = await fetch(`${API}/api/demo/load`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            status.classList.remove('hidden');
            status.className = 'mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm';
            status.innerHTML = `Done: ${data.message}`;
            
            // Refresh all data
            refreshAllDataDisplays();
            loadRestaurants();
            loadRankings();
            showToast('Demo data loaded successfully!');
        } else {
            throw new Error(data.error || 'Failed to load demo data');
        }
    } catch (err) {
        status.classList.remove('hidden');
        status.className = 'mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm';
        status.innerHTML = `Error: ${err.message}`;
        showToast('Error: ' + err.message, 'error');
    }
    
    btn.textContent = 'Load Demo Data';
    btn.disabled = false;
}

async function computeAllRankings() {
    const status = document.getElementById('demo-status');
    status.classList.remove('hidden');
    status.className = 'mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 text-sm';
    status.innerHTML = 'Computing rankings for all cities...';
    
    try {
        const res = await fetch(`${API}/api/rankings/compute`, { 
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        const data = await res.json();
        
        if (data.success) {
            status.className = 'mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm';
            status.innerHTML = 'Rankings computed successfully for all cities';
            refreshAllDataDisplays();
            loadRankings();
            loadRestaurants();
            showToast('Rankings computed');
        } else {
            throw new Error(data.error || 'Failed to compute rankings');
        }
    } catch (err) {
        status.className = 'mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm';
        status.innerHTML = `Error: ${err.message}`;
        showToast('Error: ' + err.message, 'error');
    }
}

async function clearAllData() {
    if (!confirm('This will delete ALL data including restaurants, reviews, rankings, and cities. Are you sure?')) {
        return;
    }
    
    if (!confirm('This action cannot be undone. Click OK to proceed.')) {
        return;
    }
    
    try {
        const res = await fetch(`${API}/api/demo/clear`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            showToast('All data cleared');
            refreshAllDataDisplays();
            document.getElementById('demo-status').classList.add('hidden');
        } else {
            throw new Error(data.error);
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function runHealthCheck() {
    const diagnoseDiv = document.getElementById('demo-diagnose');
    diagnoseDiv.classList.remove('hidden');
    diagnoseDiv.innerHTML = '<span class="text-yellow-400">Running comprehensive database health check...</span>';
    
    try {
        const res = await fetch(`${API}/api/db/health`);
        const data = await res.json();
        
        let output = '';
        
        // Header
        output += '╔══════════════════════════════════════════════════════════════╗\n';
        output += '║           DATABASE HEALTH CHECK REPORT                       ║\n';
        output += '╚══════════════════════════════════════════════════════════════╝\n\n';
        
        output += `Database Type: ${data.database_type}\n`;
        output += `Timestamp: ${data.timestamp}\n`;
        output += `Tables Found: ${(data.tables_found || []).length}\n\n`;
        
        // Data Counts
        output += '┌─────────────────────────────────────────────────────────────┐\n';
        output += '│ DATA COUNTS                                                 │\n';
        output += '└─────────────────────────────────────────────────────────────┘\n';
        Object.entries(data.data_counts || {}).forEach(([table, count]) => {
            const status = count > 0 ? '✓' : '○';
            output += `  ${status} ${table.padEnd(20)} : ${count}\n`;
        });
        output += '\n';
        
        // Schema Analysis
        output += '┌─────────────────────────────────────────────────────────────┐\n';
        output += '│ SCHEMA COMPATIBILITY                                        │\n';
        output += '└─────────────────────────────────────────────────────────────┘\n';
        Object.entries(data.schema_analysis || {}).forEach(([table, analysis]) => {
            const status = analysis.compatible ? '✓ COMPATIBLE' : '✗ ISSUES';
            output += `\n  [${table.toUpperCase()}] ${status}\n`;
            output += `    Actual columns: ${analysis.actual_columns.join(', ')}\n`;
            if (analysis.missing_columns.length > 0) {
                output += `    MISSING: ${analysis.missing_columns.join(', ')}\n`;
            }
            if (analysis.extra_columns.length > 0) {
                output += `    Extra: ${analysis.extra_columns.join(', ')}\n`;
            }
        });
        output += '\n';
        
        // Full Table Schemas
        output += '┌─────────────────────────────────────────────────────────────┐\n';
        output += '│ FULL TABLE SCHEMAS                                          │\n';
        output += '└─────────────────────────────────────────────────────────────┘\n';
        Object.entries(data.tables || {}).forEach(([table, info]) => {
            output += `\n  [${table}]\n`;
            (info.columns || []).forEach(col => {
                const nullable = col.is_nullable === 'YES' ? 'NULL' : 'NOT NULL';
                output += `    - ${col.column_name.padEnd(25)} ${(col.data_type || '').padEnd(15)} ${nullable}\n`;
            });
        });
        output += '\n';
        
        // Foreign Key Relationships
        output += '┌─────────────────────────────────────────────────────────────┐\n';
        output += '│ DATA RELATIONSHIPS                                          │\n';
        output += '└─────────────────────────────────────────────────────────────┘\n';
        
        const fk = data.foreign_key_check || {};
        
        if (fk.restaurants_to_regions) {
            output += '\n  [Restaurants -> Cities]\n';
            output += `    Restaurant cantons: ${(fk.restaurants_to_regions.restaurant_cantons || []).join(', ') || 'none'}\n`;
            output += `    Region codes: ${(fk.restaurants_to_regions.region_codes || []).join(', ') || 'none'}\n`;
            if ((fk.restaurants_to_regions.orphaned_cantons || []).length > 0) {
                output += `    WARNING - Orphaned cantons: ${fk.restaurants_to_regions.orphaned_cantons.join(', ')}\n`;
            }
        }
        
        if (fk.rankings_to_restaurants) {
            output += '\n  [Rankings -> Restaurants]\n';
            output += `    Rankings count: ${fk.rankings_to_restaurants.rankings_restaurant_ids_count || 0}\n`;
            output += `    Restaurants count: ${fk.rankings_to_restaurants.restaurants_ids_count || 0}\n`;
            if (fk.rankings_to_restaurants.orphaned_rankings > 0) {
                output += `    WARNING - Orphaned rankings: ${fk.rankings_to_restaurants.orphaned_rankings}\n`;
            }
        }
        
        if (fk.rankings_regions) {
            output += '\n  [Rankings Region Column]\n';
            output += `    Column used: ${fk.rankings_regions.column_used}\n`;
            if (fk.rankings_regions.values) {
                output += `    Values: ${fk.rankings_regions.values.join(', ') || 'none'}\n`;
            }
            if (fk.rankings_regions.note) {
                output += `    NOTE: ${fk.rankings_regions.note}\n`;
            }
        }
        output += '\n';
        
        // Sample Data
        output += '┌─────────────────────────────────────────────────────────────┐\n';
        output += '│ SAMPLE DATA                                                 │\n';
        output += '└─────────────────────────────────────────────────────────────┘\n';
        Object.entries(data.sample_data || {}).forEach(([table, rows]) => {
            output += `\n  [${table}] (first 3 rows)\n`;
            if (typeof rows === 'string') {
                output += `    ${rows}\n`;
            } else if (Array.isArray(rows)) {
                rows.forEach((row, i) => {
                    output += `    ${i+1}. ${JSON.stringify(row)}\n`;
                });
            }
        });
        output += '\n';
        
        // Compatibility Issues
        if ((data.compatibility_issues || []).length > 0) {
            output += '┌─────────────────────────────────────────────────────────────┐\n';
            output += '│ ⚠ COMPATIBILITY ISSUES                                      │\n';
            output += '└─────────────────────────────────────────────────────────────┘\n';
            data.compatibility_issues.forEach(issue => {
                output += `  • ${issue}\n`;
            });
            output += '\n';
        }
        
        // Recommendations
        if ((data.recommendations || []).length > 0) {
            output += '┌─────────────────────────────────────────────────────────────┐\n';
            output += '│ RECOMMENDATIONS                                             │\n';
            output += '└─────────────────────────────────────────────────────────────┘\n';
            data.recommendations.forEach((rec, i) => {
                output += `  ${i+1}. ${rec}\n`;
            });
            output += '\n';
        }
        
        // Errors
        if ((data.errors || []).length > 0) {
            output += '┌─────────────────────────────────────────────────────────────┐\n';
            output += '│ ERRORS                                                      │\n';
            output += '└─────────────────────────────────────────────────────────────┘\n';
            data.errors.forEach(err => {
                output += `  • ${err}\n`;
            });
            if (data.traceback) {
                output += `\n  Traceback:\n  ${data.traceback}\n`;
            }
        }
        
        output += '\n═══════════════════════════════════════════════════════════════\n';
        output += '                    END OF HEALTH CHECK REPORT\n';
        output += '═══════════════════════════════════════════════════════════════\n';
        
        diagnoseDiv.textContent = output;
        
    } catch (err) {
        diagnoseDiv.innerHTML = `<span class="text-red-400">Error: ${err.message}</span>`;
    }
}

async function diagnoseDemoData() {
    const diagnoseDiv = document.getElementById('demo-diagnose');
    diagnoseDiv.classList.remove('hidden');
    diagnoseDiv.textContent = 'Running diagnostics...';
    
    try {
        const res = await fetch(`${API}/api/demo/diagnose`);
        const data = await res.json();
        
        let output = '=== DATABASE DIAGNOSTICS ===\n\n';
        output += `Database Type: ${data.database_type}\n`;
        output += `Tables Found: ${(data.tables_found || []).join(', ')}\n\n`;
        
        output += `--- REGIONS TABLE ---\n`;
        output += `Columns: ${(data.regions_columns || []).join(', ')}\n`;
        output += `Count: ${data.regions_count || 0}\n\n`;
        
        output += `--- RESTAURANTS TABLE ---\n`;
        output += `Columns: ${(data.column_names || []).join(', ')}\n`;
        output += `Count: ${data.restaurants_count || 0}\n\n`;
        
        output += `--- RANKINGS TABLE (CRITICAL) ---\n`;
        output += `Columns: ${(data.rankings_columns || []).join(', ')}\n\n`;
        
        output += `--- SOURCE_RATINGS TABLE ---\n`;
        output += `Columns: ${(data.source_ratings_columns || []).join(', ')}\n\n`;
        
        output += `--- SCRAPE_JOBS TABLE ---\n`;
        output += `Columns: ${(data.scrape_jobs_columns || []).join(', ')}\n\n`;
        
        output += `--- EMAIL CONFIG ---\n`;
        output += `email_config table: ${data.email_config_exists ? 'YES' : 'NO'}\n`;
        output += `email_queue table: ${data.email_queue_exists ? 'YES' : 'NO'}\n\n`;
        
        output += `--- TEST RESULTS ---\n`;
        output += `Region Insert: ${data.test_region_insert || 'N/A'}\n`;
        output += `Restaurant Insert: ${data.test_restaurant_insert || 'N/A'}\n\n`;
        
        if (data.errors && data.errors.length > 0) {
            output += `--- ERRORS ---\n`;
            data.errors.forEach(e => output += `- ${e}\n`);
        }
        
        if (data.traceback) {
            output += `\n--- TRACEBACK ---\n${data.traceback}`;
        }
        
        diagnoseDiv.textContent = output;
        
    } catch (err) {
        diagnoseDiv.textContent = `Error running diagnostics: ${err.message}`;
    }
}

async function debugData() {
    const diagnoseDiv = document.getElementById('demo-diagnose');
    diagnoseDiv.classList.remove('hidden');
    diagnoseDiv.textContent = 'Loading database contents...';
    
    try {
        const res = await fetch(`${API}/api/debug/data`);
        const data = await res.json();
        
        if (data.error) {
            diagnoseDiv.textContent = `Error: ${data.error}\n${data.trace || ''}`;
            return;
        }
        
        let output = '=== DATABASE CONTENTS ===\n\n';
        
        // Show rankings table columns first - this is critical
        output += `--- RANKINGS TABLE COLUMNS ---\n`;
        output += `${(data.rankings_columns || []).join(', ')}\n`;
        if (data.rankings_columns_error) {
            output += `Error: ${data.rankings_columns_error}\n`;
        }
        
        output += `\n--- COUNTS ---\n`;
        output += `Restaurants Total: ${data.restaurants_total}\n`;
        output += `Restaurants Active: ${data.restaurants_active}\n`;
        output += `Cities Total: ${data.regions_total}\n`;
        output += `Rankings Total: ${data.rankings_total}\n`;
        output += `Source Ratings Total: ${data.source_ratings_total}\n\n`;
        
        output += `--- RESTAURANTS BY CANTON ---\n`;
        (data.restaurants_by_canton || []).forEach(r => {
            output += `  ${r.canton || 'NULL'}: ${r.cnt} restaurants\n`;
        });
        
        output += `\n--- REGION CODES IN REGIONS TABLE ---\n`;
        (data.region_codes || []).forEach(r => {
            output += `  ${r.code}: ${r.name}\n`;
        });
        
        output += `\n--- SAMPLE RESTAURANTS ---\n`;
        (data.sample_restaurants || []).forEach(r => {
            output += `  [${r.id}] ${r.name} | city=${r.city} | canton=${r.canton} | active=${r.is_active}\n`;
        });
        
        output += `\n--- SAMPLE RANKINGS (raw) ---\n`;
        (data.sample_rankings || []).forEach(r => {
            output += `  ${JSON.stringify(r)}\n`;
        });
        if (data.sample_rankings_error) {
            output += `Error: ${data.sample_rankings_error}\n`;
        }
        
        diagnoseDiv.textContent = output;
        
    } catch (err) {
        diagnoseDiv.textContent = `Error: ${err.message}`;
    }
}

async function loadEmailConfig() {
    const res = await fetch(`${API}/api/email/config`);
    const cfg = await res.json();
    
    document.getElementById('email-smtp-host').value = cfg.smtp_host || 'smtp.gmail.com';
    document.getElementById('email-smtp-port').value = cfg.smtp_port || 587;
    document.getElementById('email-smtp-user').value = cfg.smtp_user || '';
    document.getElementById('email-from-name').value = cfg.from_name || 'Restaurant Curation';
    document.getElementById('email-reply-to').value = cfg.reply_to || '';
    document.getElementById('email-active').checked = cfg.is_active === 1;
}

async function saveEmailConfig(e) {
    e.preventDefault();
    
    await fetch(`${API}/api/email/config`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            smtp_host: document.getElementById('email-smtp-host').value,
            smtp_port: parseInt(document.getElementById('email-smtp-port').value),
            smtp_user: document.getElementById('email-smtp-user').value,
            smtp_password: document.getElementById('email-smtp-password').value,
            from_email: document.getElementById('email-smtp-user').value,
            from_name: document.getElementById('email-from-name').value,
            reply_to: document.getElementById('email-reply-to').value,
            is_active: document.getElementById('email-active').checked ? 1 : 0
        })
    });
    
    document.getElementById('email-smtp-password').value = '';
    showToast('Email configuration saved');
}

async function saveEmailTemplate(e) {
    e.preventDefault();
    
    await fetch(`${API}/api/email/templates`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: 'welcome',
            subject: document.getElementById('template-subject').value,
            body_html: document.getElementById('template-body').value
        })
    });
    
    showToast('Email template saved');
}

async function loadEmailLog() {
    const res = await fetch(`${API}/api/email/log`);
    const logs = await res.json();
    
    const html = logs.map(l => `
        <tr class="border-b">
            <td class="py-2">${l.restaurant_name || 'Unknown'}</td>
            <td>${l.to_email || '-'}</td>
            <td class="text-gray-500 truncate max-w-xs">${l.subject || '-'}</td>
            <td><span class="text-xs px-2 py-1 rounded-full ${
                l.status === 'sent' ? 'bg-green-100 text-green-700' : 
                l.status === 'queued' ? 'bg-yellow-100 text-yellow-700' :
                l.status === 'failed' ? 'bg-red-100 text-red-700' : 'bg-gray-100'
            }">${l.status}</span></td>
            <td class="text-gray-500">${l.sent_at?.split('T')[0] || '-'}</td>
        </tr>
    `).join('');
    
    document.getElementById('email-log-table').innerHTML = html || '<tr><td colspan="5" class="py-4 text-center text-gray-400">No emails sent yet</td></tr>';
}

async function loadEmailQueue() {
    try {
        const res = await fetch(`${API}/api/email/queue`);
        const data = await res.json();
        
        let html = '';
        if (data.length === 0) {
            html = '<tr><td colspan="6" class="py-4 text-center text-gray-400">No emails in queue</td></tr>';
        } else {
            data.forEach(item => {
                const statusBadge = item.status === 'approved' 
                    ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Approved</span>'
                    : item.status === 'rejected'
                    ? '<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">Rejected</span>'
                    : '<span class="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs">Pending</span>';
                
                html += `<tr class="border-b" data-queue-id="${item.id}">
                    <td class="py-2"><input type="checkbox" class="email-checkbox" value="${item.id}"></td>
                    <td class="py-2 font-medium">${item.restaurant_name || 'Unknown'}</td>
                    <td class="py-2">${item.to_email || '-'}</td>
                    <td class="py-2">${item.city || '-'}</td>
                    <td class="py-2">${statusBadge}</td>
                    <td class="py-2">
                        <button onclick="approveEmail(${item.id})" class="text-green-600 hover:text-green-800 mr-2" title="Approve">OK</button>
                        <button onclick="rejectEmail(${item.id})" class="text-red-600 hover:text-red-800 mr-2" title="Reject">X</button>
                        <button onclick="previewEmail(${item.id})" class="text-blue-600 hover:text-blue-800" title="Preview">View</button>
                    </td>
                </tr>`;
            });
        }
        document.getElementById('email-queue-table').innerHTML = html;
    } catch (err) {
        console.error('Error loading email queue:', err);
    }
}

function toggleAllEmails(checkbox) {
    document.querySelectorAll('.email-checkbox').forEach(cb => cb.checked = checkbox.checked);
}

function getSelectedEmailIds() {
    return Array.from(document.querySelectorAll('.email-checkbox:checked')).map(cb => parseInt(cb.value));
}

async function approveEmail(id) {
    try {
        const res = await fetch(`${API}/api/email/queue/${id}/approve`, {method: 'POST'});
        const data = await res.json();
        if (data.success) {
            showToast('Email approved');
            loadEmailQueue();
        } else {
            showToast(data.error || 'Failed to approve', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function rejectEmail(id) {
    try {
        const res = await fetch(`${API}/api/email/queue/${id}/reject`, {method: 'POST'});
        const data = await res.json();
        if (data.success) {
            showToast('Email rejected');
            loadEmailQueue();
        } else {
            showToast(data.error || 'Failed to reject', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function approveSelectedEmails() {
    const ids = getSelectedEmailIds();
    if (ids.length === 0) {
        showToast('No emails selected', 'error');
        return;
    }
    
    try {
        const res = await fetch(`${API}/api/email/queue/approve-bulk`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ids})
        });
        const data = await res.json();
        showToast(`Approved ${data.approved || 0} emails`);
        loadEmailQueue();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function rejectSelectedEmails() {
    const ids = getSelectedEmailIds();
    if (ids.length === 0) {
        showToast('No emails selected', 'error');
        return;
    }
    
    try {
        const res = await fetch(`${API}/api/email/queue/reject-bulk`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ids})
        });
        const data = await res.json();
        showToast(`Rejected ${data.rejected || 0} emails`);
        loadEmailQueue();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function queuePendingEmails() {
    showToast('Checking for new emails to queue...');
    try {
        const res = await fetch(`${API}/api/email/queue/generate`, {method: 'POST'});
        const data = await res.json();
        if (data.success) {
            showToast(`Added ${data.queued || 0} emails to queue`);
            loadEmailQueue();
        } else {
            showToast(data.error || 'Failed to queue emails', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function sendApprovedEmails() {
    if (!confirm('Send all approved emails now?')) return;
    
    showToast('Sending approved emails...');
    try {
        const res = await fetch(`${API}/api/email/send-approved`, {method: 'POST'});
        const data = await res.json();
        
        if (data.error) {
            showToast('Error: ' + data.error, 'error');
        } else {
            showToast(`Sent ${data.sent} emails, ${data.failed} failed`);
            loadEmailQueue();
            loadEmailLog();
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function previewEmail(id) {
    try {
        const res = await fetch(`${API}/api/email/queue/${id}/preview`);
        const data = await res.json();
        
        if (data.html) {
            const win = window.open('', '_blank', 'width=650,height=600');
            win.document.write(data.html);
            win.document.close();
        } else {
            showToast('Could not load preview', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function sendTestEmail() {
    const recipient = document.getElementById('test-email-recipient').value.trim();
    const statusDiv = document.getElementById('test-email-status');
    const btn = document.getElementById('test-email-btn');
    
    if (!recipient) {
        statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-red-50 border border-red-200 text-red-700';
        statusDiv.textContent = '❌ Please enter a recipient email address';
        statusDiv.classList.remove('hidden');
        return;
    }
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-pulse">⏳ Sending...</span>';
    statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-blue-50 border border-blue-200 text-blue-700';
    statusDiv.textContent = '📤 Sending test email...';
    statusDiv.classList.remove('hidden');
    
    try {
        const res = await fetch(`${API}/api/email/test`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({recipient: recipient})
        });
        const data = await res.json();
        
        if (data.success) {
            statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-green-50 border border-green-200 text-green-700';
            statusDiv.innerHTML = ` <strong>Test email sent successfully!</strong><br>Check your inbox at <strong>${recipient}</strong>`;
            showToast('Test email sent!');
        } else {
            statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-red-50 border border-red-200 text-red-700';
            statusDiv.innerHTML = `❌ <strong>Failed to send test email</strong><br>${data.error || 'Unknown error'}`;
            showToast('Email test failed', 'error');
        }
    } catch (err) {
        statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-red-50 border border-red-200 text-red-700';
        statusDiv.innerHTML = `❌ <strong>Error:</strong> ${err.message}`;
        showToast('Email test failed', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = ' Send Test Email';
    }
}

// ========== HEALTH CHECK ==========

let lastHealthCheckData = null;

async function runFullHealthCheck() {
    const btn = document.getElementById('health-check-btn');
    const progress = document.getElementById('health-progress');
    const progressText = document.getElementById('health-progress-text');
    const results = document.getElementById('health-results');
    const summary = document.getElementById('health-summary');
    const overall = document.getElementById('health-overall');
    
    btn.disabled = true;
    progress.classList.remove('hidden');
    progressText.textContent = 'Running backend checks...';
    results.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-4">Running checks...</div>';
    
    try {
        // Run backend health check
        const res = await fetch(`${API}/api/health/full`);
        const data = await res.json();
        lastHealthCheckData = data;
        
        progressText.textContent = 'Running frontend checks...';
        
        // Run frontend checks
        const frontendResults = await runFrontendChecksInternal();
        
        // Display results
        displayHealthResults(data, frontendResults);
        
        // Update JSON view
        document.getElementById('health-json').textContent = JSON.stringify(data, null, 2);
        
    } catch (e) {
        results.innerHTML = `<div class="col-span-2 bg-red-100 text-red-700 p-4 rounded-lg">
            <strong>Health check failed:</strong> ${e.message}
        </div>`;
    }
    
    progress.classList.add('hidden');
    btn.disabled = false;
}

function displayHealthResults(data, frontendResults) {
    const results = document.getElementById('health-results');
    const summary = document.getElementById('health-summary');
    const overall = document.getElementById('health-overall');
    const statusIcon = document.getElementById('health-status-icon');
    const statusText = document.getElementById('health-status-text');
    const timestamp = document.getElementById('health-timestamp');
    
    // Update overall status
    const status = data.overall_status || 'unknown';
    const statusColors = {
        'pass': { bg: 'bg-green-100', icon: 'bg-green-500', text: 'All Systems Operational' },
        'warning': { bg: 'bg-amber-100', icon: 'bg-amber-500', text: 'Some Issues Detected' },
        'fail': { bg: 'bg-red-100', icon: 'bg-red-500', text: 'Critical Issues Found' },
        'unknown': { bg: 'bg-gray-100', icon: 'bg-gray-400', text: 'Status Unknown' }
    };
    
    const colors = statusColors[status];
    overall.className = `mb-6 p-4 rounded-lg ${colors.bg}`;
    statusIcon.className = `w-12 h-12 rounded-full ${colors.icon} flex items-center justify-center`;
    statusIcon.innerHTML = status === 'pass' 
        ? '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
        : status === 'fail'
        ? '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'
        : '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
    statusText.textContent = colors.text;
    timestamp.textContent = `Last check: ${new Date(data.timestamp).toLocaleString()}`;
    
    // Update summary
    summary.classList.remove('hidden');
    document.getElementById('health-passed').textContent = data.summary?.passed || 0;
    document.getElementById('health-warnings').textContent = data.summary?.warnings || 0;
    document.getElementById('health-failed').textContent = data.summary?.failed || 0;
    
    // Build results HTML
    let html = '';
    const categories = ['database', 'tables', 'data_integrity', 'configuration', 'external_services', 'api_endpoints'];
    const categoryNames = {
        'database': 'Database',
        'tables': 'Database Tables',
        'data_integrity': 'Data Integrity',
        'configuration': 'Configuration',
        'external_services': 'External Services',
        'api_endpoints': 'API Endpoints'
    };
    
    for (const cat of categories) {
        const catData = data[cat];
        if (!catData) continue;
        
        const catStatus = catData.status;
        const catColor = catStatus === 'pass' ? 'border-green-500' : catStatus === 'fail' ? 'border-red-500' : 'border-amber-500';
        const catBg = catStatus === 'pass' ? 'bg-green-50' : catStatus === 'fail' ? 'bg-red-50' : 'bg-amber-50';
        
        html += `<div class="border-l-4 ${catColor} ${catBg} rounded-lg p-4">
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-medium">${categoryNames[cat] || cat}</h4>
                <span class="text-xs px-2 py-1 rounded ${catStatus === 'pass' ? 'bg-green-200 text-green-800' : catStatus === 'fail' ? 'bg-red-200 text-red-800' : 'bg-amber-200 text-amber-800'}">${catStatus.toUpperCase()}</span>
            </div>
            <div class="space-y-1 text-sm">`;
        
        for (const check of (catData.checks || [])) {
            const icon = check.status === 'pass' 
                ? '<span class="text-green-600">✓</span>'
                : check.status === 'fail'
                ? '<span class="text-red-600">✗</span>'
                : '<span class="text-amber-600">⚠</span>';
            html += `<div class="flex justify-between items-start gap-2">
                <span class="flex items-center gap-1">${icon} ${check.name}</span>
                <span class="text-gray-500 text-xs text-right max-w-[200px] truncate" title="${check.message}">${check.message}</span>
            </div>`;
        }
        
        html += '</div></div>';
    }
    
    results.innerHTML = html;
    
    // Show frontend checks if available
    if (frontendResults && frontendResults.length > 0) {
        const frontendDiv = document.getElementById('frontend-checks');
        const frontendResults_div = document.getElementById('frontend-results');
        frontendDiv.classList.remove('hidden');
        
        let fhtml = '';
        for (const check of frontendResults) {
            const color = check.status === 'pass' ? 'bg-green-100 text-green-700' : check.status === 'fail' ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700';
            const icon = check.status === 'pass' ? '✓' : check.status === 'fail' ? '✗' : '⚠';
            fhtml += `<div class="p-2 rounded ${color} text-xs">
                <span class="font-medium">${icon} ${check.name}</span>
                <div class="text-xs opacity-75">${check.message}</div>
            </div>`;
        }
        frontendResults_div.innerHTML = fhtml;
    }
}

async function runFrontendChecks() {
    const results = await runFrontendChecksInternal();
    
    const frontendDiv = document.getElementById('frontend-checks');
    const frontendResults = document.getElementById('frontend-results');
    frontendDiv.classList.remove('hidden');
    
    let html = '';
    for (const check of results) {
        const color = check.status === 'pass' ? 'bg-green-100 text-green-700' : check.status === 'fail' ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700';
        const icon = check.status === 'pass' ? '✓' : check.status === 'fail' ? '✗' : '⚠';
        html += `<div class="p-2 rounded ${color} text-xs">
            <span class="font-medium">${icon} ${check.name}</span>
            <div class="text-xs opacity-75">${check.message}</div>
        </div>`;
    }
    frontendResults.innerHTML = html;
}

async function runFrontendChecksInternal() {
    const checks = [];
    
    // Check if key functions exist
    const requiredFunctions = [
        'showSection', 'loadDashboard', 'loadRestaurants', 'loadRankings',
        'loadApiKeys', 'loadCities', 'loadWeights', 'loadSentimentStats',
        'showToast', 'refreshData', 'saveWeights', 'loadCostAnalytics',
        'quickPreview', 'fetchDetailsForSelected', 'importSelected',
        'loadKeywords', 'addKeyword', 'reanalyzeReviews'
    ];
    
    for (const fn of requiredFunctions) {
        if (typeof window[fn] === 'function') {
            checks.push({ name: fn, status: 'pass', message: 'Function defined' });
        } else {
            checks.push({ name: fn, status: 'fail', message: 'Function not defined' });
        }
    }
    
    // Test API connectivity
    const apiTests = [
        { url: '/api/stats', name: 'Stats API' },
        { url: '/api/regions', name: 'Regions API' },
        { url: '/api/restaurants', name: 'Restaurants API' },
        { url: '/api/rankings', name: 'Rankings API' },
        { url: '/api/keys', name: 'API Keys' },
        { url: '/api/costs', name: 'Costs API' },
        { url: '/api/sentiment/stats', name: 'Sentiment Stats' }
    ];
    
    for (const test of apiTests) {
        try {
            const res = await fetch(`${API}${test.url}`);
            if (res.ok) {
                const data = await res.json();
                if (data.error) {
                    checks.push({ name: test.name, status: 'warning', message: data.error.substring(0, 30) });
                } else {
                    checks.push({ name: test.name, status: 'pass', message: `HTTP ${res.status}` });
                }
            } else {
                checks.push({ name: test.name, status: 'fail', message: `HTTP ${res.status}` });
            }
        } catch (e) {
            checks.push({ name: test.name, status: 'fail', message: e.message.substring(0, 30) });
        }
    }
    
    // Check DOM elements
    const requiredElements = [
        'stat-restaurants', 'stat-cities', 'stat-reviews', 'stat-published',
        'globalCity', 'rankings-table', 'restaurant-table', 'recent-jobs'
    ];
    
    for (const id of requiredElements) {
        const el = document.getElementById(id);
        if (el) {
            checks.push({ name: `DOM: ${id}`, status: 'pass', message: 'Element found' });
        } else {
            checks.push({ name: `DOM: ${id}`, status: 'fail', message: 'Element missing' });
        }
    }
    
    return checks;
}

function toggleHealthJson() {
    const json = document.getElementById('health-json');
    json.classList.toggle('hidden');
}

// ========== UTILS ==========

function showToast(msg, type='success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transition-all z-50 ${type === 'error' ? 'bg-red-600' : 'bg-gray-800'} text-white`;
    // Remove pointer-events-none when showing
    t.style.pointerEvents = 'auto';
    setTimeout(() => {
        t.classList.add('translate-y-20', 'opacity-0');
        t.style.pointerEvents = 'none';
    }, 3000);
}

async function refreshData() {
    try {
        await refreshAllDataDisplays();
        showToast('Data refreshed');
    } catch (err) {
        showToast('Error refreshing data', 'error');
    }
}

// Init
loadDashboard();
</script>
</body>
</html>
